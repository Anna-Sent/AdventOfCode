package advent2019;

import utils.Point;

import java.util.*;

public class AoC2019Day18Part2 {

    public static void main(String[] args) {
        int result;

        result = test("#################################################################################\n" +
                "#.....#...............#.....#.A.#.......#.....#e..............#.....#...........#\n" +
                "#.###.#########.#####.###.#.###.#.###.#.###.#.###.###########.#.#.###.#####.#####\n" +
                "#.#.#.....#...#.#...#.#...#.....#.#.#.#.#...#..m#...#.......#.#.#.#...#.#...#...#\n" +
                "#.#.#####.#.#.#.#.###.#.#########.#.#.###.#####.###.#.#######.###.#.###.#N###.#.#\n" +
                "#.#.#...#...#...#...#.#.....T.......#...#.#...#.....#.#.....#.#...#.....#.#...#.#\n" +
                "#.#.#.#.###########.#.#.###############.#.#.#.#######.#.###.#.#.#.#####.#.#.###.#\n" +
                "#.#...#.......#.....#.#.......#.....#...#.#.#...#.........#j....#.#...#.#.#.#...#\n" +
                "#.###########.#.#.#.#.#########.###.#.#.#.#.###.#.#########.#####.###.#.#.#.#.#.#\n" +
                "#.#.....#...#.#.#.#.#...........#...#.#.#.#...#.#.#...#...#.#...#...#.#.#...#.#.#\n" +
                "#.#P###.#D#.#.#.#.###############.###.#.#.###.#.#.###.#.#.###.#.###.#.#.#####.###\n" +
                "#...#...#.#.#u..#.......#...#.....#...#.#.#...#.......#.#.....#...#...#.....#...#\n" +
                "#####.###.#.#######.###.#.###.#######.#.#.#########.###.#########.#########.###.#\n" +
                "#...#.#...#g......#...#.#...#.#.....#.#.#.#...#...#.#...#.......#.#.........#...#\n" +
                "#.#.#.#.#########.###.#.###.#.###.#.#.#.#.#.#.#.#.###.#######.#.#.#.#########O#.#\n" +
                "#.#...#..d#.....#...#.#.....#.....#...#.#...#...#.....#.....#.#.#...#.....#...#.#\n" +
                "#.#######.#.###F###.#.#################.#.###############.#.#.#.#######.#.#.###.#\n" +
                "#.....#...#..h#...#.#.............#.....#.#.......#.......#...#.....#...#.#.#...#\n" +
                "#.###.#H#####.#.###G#.#######.#####.#####.###.#.#.#.###.###########.#.###.#.#####\n" +
                "#.#.#.#.......#.#...#.....#...#...#.#...#...#.#.#.#...#.#...#.....#...#.#.#.....#\n" +
                "#.#.#.#########.#.#########.###.#.#.###.###.#.#.#.#####.#.#.#####.#####.#.#####.#\n" +
                "#...#.....#.....#b..#...#...#...#...#...#...#.#.#.....#...#.#y..#.......#.....#.#\n" +
                "###.#####.#.#######.###B#.#.#.#######.#.#.#####.#####.#.###.###.#####.#.#.#####.#\n" +
                "#...#...I.#f......#.....#.#.#.#...#...#.#...#...#...#.#.#.....#.....#.#...#.....#\n" +
                "#####.###########.#######.###.#.###.#.#####.#.###.###.###.#########.#######.#####\n" +
                "#o....#k........#.#.#.......#.#.#...#...#.#.#.#.....#.#...#.......#.......K.#...#\n" +
                "#.#####.###.#####.#.#.#####.#.#.#.#####.#.#.#.###.#.#.#.###.###.###############.#\n" +
                "#.#.......#...#.C.#.....#...#.#...#...#.#...#...#.#.#.#...#...#.....#...........#\n" +
                "#.#.#########.#.#########.###.###.#.###.#.#####.#.#.#.###.###.#####.#.#.#######.#\n" +
                "#...#l........#...#.....#...#...#...#...#.......#.#...#...#...#...#...#.X.#...#.#\n" +
                "#.###.#.#########.#V###.###.###.#####.###########.#####.###.###.#########.#.#.#.#\n" +
                "#...#.#.#.....#...#.#.#.#...#.#.....#...#.......#...#...#...#...........#.#.#.#.#\n" +
                "#####.#.#.###.#.###.#.#.#.#.#.#####.###.#.#####.###.#.#.#.###.#######.###.#.#.#W#\n" +
                "#.....#.#.#r#.#.#...#.#.#.#.#.#...#...#.#.#...#...#.#.#.#...#.......#...#.#.#.#.#\n" +
                "#.#######.#.#.#.###.#.#.#.#.#.#.#.###.#.#.###.###.#.#.#.###.###########.#.#.#.#.#\n" +
                "#.........#.#.#.#s..#...#.#.Q.#.#.#...#.#...#...#...#.#.............#...#.#.#...#\n" +
                "#.#########.#.#.#.###.###.#.###.#.#.###.###.#.#.#####.#######.#####.#.###.#.#####\n" +
                "#...#...#...#.#...#...#...#.#...#...#...#.#.#.#.....#...#...#.#...#...#...#...#.#\n" +
                "###.#Y#.###.#.#####.###.#####.#########.#.#.###.###.#####.#.###.#.#####.#####.#.#\n" +
                "#.....#.....#.......#...........................#.........#....q#.......#.......#\n" +
                "#######################################.@.#######################################\n" +
                "#...#.#.................#..z..............#.......#.............#...............#\n" +
                "#.#.#.#.#.#############.#.#.###########.#.#.#.#####.#####.#####.#.###.#########.#\n" +
                "#.#...#.#.#...#.#.....#.#.#.#.....#...#.#...#.#...Z.....#.#.....#.#.#.#.......#.#\n" +
                "#.#####.#.#.#.#.#.#.#.#.###.#.#####.#.#.#.###.#.#########.#######.#.#.#####.###.#\n" +
                "#.#...#.#...#.#...#.#x#.#...#.#.....#.#.#...#.....#.....#.#...#.....#.#...#.....#\n" +
                "#.#.#.#.#####.#####.###.#.###.#.#####.#.###.#######.###.#.#.#.#.#####.#.#.#####.#\n" +
                "#w..#...#...#.....#.#.....#...#.#.....#.#.#...#.....#.#...#.#...#..v#.#.#.....#.#\n" +
                "#.#######.#.#####.#.#.#####.###.#.#####.#.###.#.#####.#.###.#####.#.#.#.#####.###\n" +
                "#.#.......#.#.#...#.#.#...#.#...#.#...#.#...#.#.#.......#...#...#.#.#.#.#...#...#\n" +
                "#.###.#.###.#.#.###.#.#.#.#.#.###.#.#.#.#.###.#.###.#####.###.#.#.#.#.#.###.###.#\n" +
                "#...#.#...#...#.#.#...#.#.#...#.#.#.#...#...#.#...#.#...#.#...#.R.#.#.........#.#\n" +
                "###.#####.###.#.#.#.###.#.###.#.#.#.#####.#.#.###.#.#.#.#.#.#######.#.#########.#\n" +
                "#.#...#...#.#.#.#.....#.#...#...#.......#.#.#...#.#...#.#.#.#...#...#.#.........#\n" +
                "#.###.#.###.#.#.#######.###.#.#########.#.#.###.#.#######.#.#.###.###.#.#######.#\n" +
                "#...#...#...#.#.........#...#.#...#.....#.#...#.#.........#.#.#...#...#.#.......#\n" +
                "#.#######.#.#.###########.#####.#.#####.###.###.###########.#.#.#######.#########\n" +
                "#.........#.#.#.........#.......#.#...#.#...#...#...........#.#.#.....#.........#\n" +
                "#.###.#######.#.###.#####.#####.#.#.#.###.#.#.###.###########.#.#.###S#########.#\n" +
                "#...#.......#...#...#...#.#...#.#...#...#.#.#...#.....L.#.....#...#...#...#...#.#\n" +
                "#.#########.#####.###.#.###.#.###.#####.#.#####.#######.#.#########.###.#.#.#.#.#\n" +
                "#.#.......#.#...#.#.#.#.#...#...#...#...#...........#...#...#.#....c#...#...#.#.#\n" +
                "###.#####.#.#.#.#.#.###.#.#####.#####.###.###########.#####.#.#.#####.#######.#.#\n" +
                "#...#.......#.#...#...#...#...#...#...#.#...#.........#.....#...#.......#.......#\n" +
                "#.###.#######.#####.#######.#.###.#.###.###.#.###########.#.#########.#.#######.#\n" +
                "#.#.#.#...#...#.............#...#...#...#...#.............#.........#.#.#.....#.#\n" +
                "#.#.#.#.#.#.###########.#####.#.#####.###.#########################.###.#.###.#.#\n" +
                "#.#...#.#.#.....#.....#...#...#.#.#.....#.....#...#.......#.......#...#...#...#.#\n" +
                "#.#####.#.#####.#.###.#####.###.#.#.###.#####.#.###.###.###.#####.###.#####.#####\n" +
                "#.......#...#.#...#.#.#.....#.#.#...#...#...#.#.#.....#.........#...#.....#.....#\n" +
                "#.#######.#.#.#####E#.#.#####.#.#.###.#.#.#.#.#.#.#############.#.#.#####.###.#.#\n" +
                "#...#.....#...#...#...#.#.....#.#...#.#.#.#...#.....#..a#.....#.#.#...#.#...#.#.#\n" +
                "#####.#######.#.###.###.#.###.#.#.###.#.#.###########.#.#.###.###.###.#.###.###.#\n" +
                "#...#.#.#...#.#.#...#...#.#...#.#.#...#.#.....#.....#.#.#.#.#...#...#...#.#...#.#\n" +
                "#.#.#.#.#.#.#.#.#.###.#.#.#.#.#.###.###.#####.#.###.#.#.#.#.###.###.###.#.###.#.#\n" +
                "#.#.#.#.#.#.....#.#...#.#.#.#.#.....#.#.#.....#.#...#.#...#...#...#.#.#.#...#..i#\n" +
                "#.#.#.#.#.#######.#####.###.#########.#.#.#####U#.###.#######.###.#.#.#.#.#.#####\n" +
                "#.#n..#.......#...#...#...#.#...#.......#.......#t#...#.........#.#.#.#...#.#...#\n" +
                "#.#############.###.#.###.#.#.#.#.###############.#.###.#.#######.#.#.#####.#.#.#\n" +
                "#...............J...#.....#...#.........#...........#...#.........M.#..p......#.#\n" +
                "#################################################################################");
        // assert result ==  : "unexpected result is " + result;
        System.out.println(result);
    }

    private static int test(String s) {
        Map<Point, Character> map = new HashMap<>();
        Set<Character> allKeys = new HashSet<>();
        Point initialPoint = null;

        String[] tokens = s.split("\n");
        for (int i = 0; i < tokens.length; ++i) {
            char[] token = tokens[i].toCharArray();
            for (int j = 0; j < token.length; ++j) {
                char ch = token[j];
                Point point = new Point(j, i);
                map.put(point, ch);
                if ('a' <= ch && ch <= 'z') {
                    allKeys.add(ch);
                } else if (ch == '@') {
                    assert initialPoint == null : "invalid input";
                    initialPoint = point;
                }
            }
        }
        assert initialPoint != null : "invalid input";

        Set<Point> initialPoints = new HashSet<>();

        map.put(initialPoint, '#');
        Point next;

        next = new Point(initialPoint);
        --next.x;
        map.put(next, '#');

        next = new Point(initialPoint);
        ++next.x;
        map.put(next, '#');

        next = new Point(initialPoint);
        ++next.y;
        map.put(next, '#');

        next = new Point(initialPoint);
        --next.y;
        map.put(next, '#');

        next = new Point(initialPoint);
        ++next.x;
        ++next.y;
        map.put(next, '@');
        initialPoints.add(next);

        next = new Point(initialPoint);
        ++next.x;
        --next.y;
        map.put(next, '@');
        initialPoints.add(next);

        next = new Point(initialPoint);
        --next.x;
        ++next.y;
        map.put(next, '@');
        initialPoints.add(next);

        next = new Point(initialPoint);
        --next.x;
        --next.y;
        map.put(next, '@');
        initialPoints.add(next);

        return bfs(map, allKeys, new State(initialPoints, Collections.emptySet()));
    }

    private static int bfs(Map<Point, Character> map, Set<Character> allKeys, State initialState) {
        Set<State> closed = new HashSet<>();
        Set<State> opened = new HashSet<>();

        int count = 0;
        opened.add(initialState);
        while (opened.size() > 0) {
            Set<State> achievable = new HashSet<>();
            for (State current : opened) {
                if (allKeysCollected(current, allKeys)) {
                    return count;
                }
                Set<State> set = generateNext(current, map);
                for (State next : set) {
                    if (!closed.contains(next)) {
                        achievable.add(next);
                    }
                }

                closed.add(current);
            }

            ++count;
            opened = achievable;
        }
        return count;
    }

    private static Set<State> generateNext(State current, Map<Point, Character> map) {
        Set<State> set = new HashSet<>();

        for (Point currentPoint : current.current) {
            Set<Point> currentPoints = new HashSet<>(current.current);
            currentPoints.remove(currentPoint);

            Point nextPoint;

            nextPoint = new Point(currentPoint);
            ++nextPoint.x;
            putState(map, set, nextPoint, currentPoints, current.collected);

            nextPoint = new Point(currentPoint);
            --nextPoint.x;
            putState(map, set, nextPoint, currentPoints, current.collected);

            nextPoint = new Point(currentPoint);
            ++nextPoint.y;
            putState(map, set, nextPoint, currentPoints, current.collected);

            nextPoint = new Point(currentPoint);
            --nextPoint.y;
            putState(map, set, nextPoint, currentPoints, current.collected);
        }

        return set;
    }

    private static void putState(Map<Point, Character> map, Set<State> set, Point point,
                                 Set<Point> currentPoints,
                                 Set<Character> collected) {
        if (!map.containsKey(point)) {
            return;
        }
        char charAtPoint = map.get(point);
        if (charAtPoint == '#') {
            return;
        }
        if (charAtPoint == '.' || charAtPoint == '@') {
            Set<Point> newCurrent = new HashSet<>(currentPoints);
            newCurrent.add(point);
            set.add(new State(newCurrent, collected));
        }
        if ('a' <= charAtPoint && charAtPoint <= 'z') {
            Set<Character> newCollected = new HashSet<>(collected);
            newCollected.add(charAtPoint);
            Set<Point> newCurrent = new HashSet<>(currentPoints);
            newCurrent.add(point);
            set.add(new State(newCurrent, newCollected));
        }
        if ('A' <= charAtPoint && charAtPoint <= 'Z' && collected.contains((char) (charAtPoint - 'A' + 'a'))) {
            Set<Point> newCurrent = new HashSet<>(currentPoints);
            newCurrent.add(point);
            set.add(new State(newCurrent, collected));
        }
    }

    private static boolean allKeysCollected(State current, Set<Character> allKeys) {
        return current.collected.equals(allKeys);
    }

    private static class State {

        Set<Point> current;
        Set<Character> collected;

        State(Set<Point> current, Set<Character> collected) {
            this.current = current;
            this.collected = collected;
        }

        @Override
        public boolean equals(Object o) {
            if (this == o) return true;
            if (o == null || getClass() != o.getClass()) return false;
            State state = (State) o;
            return Objects.equals(current, state.current) &&
                    Objects.equals(collected, state.collected);
        }

        @Override
        public int hashCode() {
            return Objects.hash(current, collected);
        }
    }
}
