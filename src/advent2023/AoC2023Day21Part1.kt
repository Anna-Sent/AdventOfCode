package advent2023

import utils.Point
import utils.plus

private var result = 0

fun main() {
    result = test(
        """
            ...........
            .....###.#.
            .###.##..#.
            ..#.#...#..
            ....#.#....
            .##..S####.
            .##..#...#.
            .......##..
            .##.#.####.
            .##..##.##.
            ...........
    """.trimIndent(), 6
    )
    check(16, result)

    result = test(
        """
            ...................................................................................................................................
            .#....................#..#......##.#..#.#..#.#..#.#.........#....................##......##...#....#.....#..#.....#........#.......
            .........#......#.#.........#...#.#...##..#.......#..#...................#........#..........#.#..##...#...#.......................
            ..#...#...#..#..#.#..#......#.....#...#....##..............................#......#.....#........#.......#.#.......#..#......#.....
            ............#................#...#.............#.........................#..................#....#..............#......##..#.......
            .##....#...#....#............#.#..................#.#...#.................#......#.....#..........#.....#.#.#...........#..........
            ..###....#.#.#....#....##............##.#...#...............................#.#..#.#.........#....................#.#....###.#.....
            ..#....##.......#...##..#......#.....................#..........#...#............#.........#.........##......#......#..#......#....
            ....................#......##.............#.#.................................#.....#..#.#..#....#...##........#....#..............
            ................#...........#.#.....#.#....#.................#.....#...................#..............#....#..#......#......#......
            .....#.....#...........#.............#.##......#.#..............#................#........#..#..#....#....#....#.#..........#.#....
            ..#......#..........#.............#..........#...#.................#.##..................#.##.....#......##.......#...#.........##.
            .......#..#..#.......#.......#...##.#....#.....#...........#...#....#..#..............#.............#......#..#....................
            ..#..#.........#.......#...#..............#.............#......#....#...................#..........##.....##.##.....#.....#.#......
            .....#....###....#......#..#..#..#........#..#............#.....#.....#.#.#..................#.......#...........##................
            .........#....#.....#...........#..##..##.......................#..#.......#.............#....##...##...#...#...##........#...#....
            .#...#..#.....#.......#.#......#.......#.#.............#..#.#.....#.#.#......#.........#.........#...........#..#.....##....#......
            .....#.#.#...............#...........###.#..............#.#..#......#...................#...#....##.........#..#..#.#...#.#........
            ......#..........#....##.....#.......#.....#..........#......###....#.......#...........#......#..............#.........#..#.#.....
            ...#......#............#............#.#..#........#.....#.......#..............#.............#.........#...........#...............
            ..............##........#.##..#....................#.......#...............#...#.............#...#..##.........#.......#.........#.
            ..........##....#..#.........#...#..............#.....##..#.....................#...........##.......................#...........#.
            ......#..........##..............#...................#...#..#.....#.....#.......#...............#.........#..#......#........#.....
            ....#.#.............#.....#...#.....#.#........#.#...#...###..#........#..#...#.............#.........#.....................##.....
            ....#...#.........#..............#..............#.......####.........#..............##...........###.......#.....#........##..#..#.
            ..#...#...........#.#...#...#...............................#............#....................#...#....#..#...#.#...........#..#...
            ..#.....##..#.#.........................................#.........#....#......#....#..#....................#.#........#..........#.
            ..#...#..#...#......#.#.......#...............#.#......##..#..#.........#.............#......................#....##...##.#........
            ...#.#.#..............#...##..............#...#............#...............#...........#.#.........#..#.......#.#.#...........#....
            ............#.....#....#.....##...............#......#..........#.....#........#........#..............#...#.#.....#.#.............
            ............#........##.................#......#...............................#.#.#................#...#.................#..#.....
            ......#...#....#............#.........#.......#....#...................#........#..........#...............#...........#...........
            ........#............#......##.......#...........#.......#.............#.....................................#...........#.........
            ..........#.....#.........#.#.......................#..........##.........#....#........#.....#..........##..................##....
            ..........#........................#.............#.......##..#......#..........#...........#.............#....#..#..#....#......#..
            ......#........#........#.........#.......#....#..................#.........##.....#......#....................#...#.........#.....
            ...#..#....#....#.................#...#.....#.....##....................#.......##.....#...#...##.......................##.....#...
            ...##........#.....................#.........#..##....#.................###........#.......#..............#...#...#.......#....##..
            .......#...........##.............#......##.............##.##........##...#..#..#.#.......#..#.#...........#...#...................
            .........#.......##.............#............##.....#........#...............#.#.....#.....#.#..............#.......##...#.........
            .......##...#....#...........#...........#..............#..#..#.........####..........#....##.................#..............#.....
            ....#..........................#..........#.............#..........#...#...........#.......#............................##.........
            ...#...#.....###.................................##...............................#....#...#..##.................................#.
            ..#....#.#......#............#...#......##.....#.....#..##...#.........#.....#.............#......#...#............#...............
            ......#.....#.##................#.......##.##........#.........................#..............................................#....
            .#....#..................#.#...............#..#......##.......##...............#....####..........#...#........................#...
            ...#........#..........#.................#....#.........#....#.....#.........#.....#.#.......##.......#................#..##.......
            .#.......#.#..#............##...........#......#.#.......................#.........#.....#.....#.....###...............#.#..##.....
            .......................#...#...........#.........#....###.......................#.........###.#.#....#......#........##............
            ..#....................#.................#.#.##.#........#..#......#....#......##......#............#..#..............#....#....#..
            .......................##.##.#..#.....###....#..#.#...#............#........#.....#....#.#.....#..#....#......................##...
            ....#.....#.........##..#....#..#.........#...#...#..##........#......###.....#..................#......................#..........
            .#.#................#..#.#...#........................#....##..#.............#...#.#.......#........#.#.....##................#....
            .##..#..........#..#.#........##............#.......#..........#....#.#...#....##.#...#..##...........#.......................#....
            .#.#.##..................#............#.#......#.........#............#.#....#..#.........##..#..................##...........##.#.
            ..............#..........#...#...##..........#.....................#..#..............#.....#.#...........#.....#....#.......#......
            ..###.........#........###...#...........#..##.##..###....#...#................#.....#......#...##...................#...........#.
            ..#...........#.................##........#.........#...#.....##......##...#.........#......#.............#...#..#.................
            ..#.............#..........#.#.............#.....#............#....#.#......#....................#.#.......#.#.....#............##.
            ..........#...........#...#...#...#................#......#................#..........................##.##.....#..#..#.#..........
            ..............#....#......#............#.....#.......#..#..........................#..#...............................#............
            ............#.............#...........##...#.##..#.........#....#.....#..#.....#...............##....#.................#...........
            ...........#.....#.##..............#....#..........#......#.......#..##....##.......#.........#.......#....#...#..........#........
            ......#...#...#..............#.#...##.#..#........#.....#.......#...#.........#.....#.....##.........#.#...........................
            ..............#..#........#......##.......#......#...#.#........#.............#...##.............#.#.#...............##....#.......
            .................................................................S.................................................................
            .........#.....#.#.#..........#.#.............#..#.....................##......##.#.............#.#.......#.........#...#..........
            .........#......#......#......#..........#...........................#...#......#..........#..#.#..........#......#..#..#...#......
            ........#.#...............##...............................#.#..............#.#....##..#...#...#....#..#.................#.........
            .............#..#....#............#........#.#......#........#.......#....#......#...#.#..........#....##......#.#.................
            ............#..........#.............#.#..............#.....#.....#...#...#........#.#........#.#........#.#.......................
            .................#........#......#....#.#................#..............#.....#.#.....#.............#.#........#.#...#.............
            ...........#....#.##...........#..#...................................#.#...#........#.......#.........#...#..##..##...............
            .....................#.#..#...#.#..........#....##...#.................#...............#.......................#...................
            ..............#..#.............#.#...........#....#.......#.........#.......#.........#...#.#.........##............#..............
            ....#.............##....#......#..........................##.........#.#.........#.....#...#..............#........................
            ....#............#...........#.####....#...#.......#..#.........#...#.............#...........#...#...........#.##...........#.#...
            ..##..............#...............#...#.#..#....##.....................#..#.....#.............#....#.......#..###.............##.#.
            .....#.##........#....#...##.#..###...#......#..##.#.....#..#.#.#........##......#............#.......#.....#....#...........##....
            .#......................#.#.......#........#.#.#.........##.....#.....#..#........#..#..#...#..##.......#...............#..........
            .....#...#.............................#.....#.....#......##......#...##........#.#.........................###.........#..........
            ...#........#...................#....#...........#..#....#...#.........#...........##.#..#..#..#...........##............#.........
            ......##..#..........##..#..#...........#......#...#........#.....#........#...........#........#............#........#.......#....
            .......#.......................#....#......###..#..#..#.........#.##..#................#.....#...............................#.....
            ...#.........#............................................#...#....#...........#.#..................#.....##.......#...#........#..
            ..##..###.......#........#................#.....#..................##.........#..#..#...........#..##...###.........###...#...#....
            ..........#.....#.............#.#..#.#...........##.........#..............................#..#.......#.#................#.#.#.....
            .......#..................#............##.............#..............#.#........#.#..............#...#..........................#..
            ...#.......#.....#..........................#...#...#...........#..#.............#.........#..........#.............#........#.....
            ..............#................##......#.#......#........................####...#.....#....#....#..................#.#.#........#..
            ........#.....#.#....#....................##......................................#...#..#.......#..........................##.....
            ...#.#.........#.#..#.............#...#....##.......#......................##...#.#.........#.....#..........#.....................
            ..#.#......#...#......##............#......#....#.#..#.#..........#....#......##..#................................#...............
            ........###..##....##...........................#.#.#.##..###........#....#............#........##.........#...#...................
            ....#............................#.#.........#.........#...#.......#.................#..#......#.........#..#.....#...#.#....#...#.
            ..#.#..........#..........#.........#..#...#..........#.....#....................#.#..#.......#...........#............#...........
            .......#.....#...........##.........#.....#..........#....#..#......#...........#...##....#......................#....#.......#....
            ..##......#...##.............................##..........#....#..............#..........#..............##..#....##.#........##.....
            ....#......#....#.#..................#..........#....#.#..##.#.##........#.............................#...............#.......#.#.
            .............#..#......#.................#.#..#....####........#......#......#....#.#.....................#.#.#.#..#...............
            .##......#........##........#.............#.#.###.....#.............#.......#..##....#...#....................##..###.......#......
            ....#.#......##.#.......#......#......................#.......#.........#..#...........#................#.........#..#...#....#....
            ..........#....#..#...........#.................#...#..#.....................#.#........##.......#.#....#..#................##...#.
            ......#....#.......#.......#..#...........#......#............#......#................#..........#...#.......##...#....#.#.........
            ...#..##...##....#..#.......#....#.................#.#.....#....#........#..#.....####.#...........#..#............#...#..##.....#.
            ..#......#...................#...............................#............#.....##.............#..#...#..##.#......#...............
            ....#.........#.........#..............................#...#....#..#.#..............#...............#..##.........#.......#....#...
            .....#.........#....#.............#............................#.................##............#...#......#..........#.....#.....#.
            ...#.#....#.......##...#....#............................##.#...#.......#...##...................#..........#.#....................
            ...........#..#.###.....##...#.........#...........#..#.#.........#.#.#.......#.................#....#............###.........#..#.
            .##..........#..#......#.....##.##.#...##.........#.................#....#.#.....#.................#.....#...#....#.....###..#.#...
            ......#.#..##.#.......#...#..#........................#..#..........#.#....#..##........#...#.#.............#.#....................
            .......#.#.............#..#.........................#.##..........##......................#...##.........#....#..........#..###....
            ...............#..#...#.........#.........#.................#.#......#....................#.........#.......................#.#....
            .....#.................#.#...............##............................####...................##....#......#.#....##..#..#.......#.
            ....#..#.......#.#...#.......................##.........#..#.......#.#.#............#...........#.###............#......#...##.....
            ..#.#..........#..#.......#...#.........#....#.........#....#...#.......#.#..........##..##........................#..........##...
            ....#...##......##......#.......#....###..............................#.##........................#......##.......#............#...
            ...........#......#.#......#.............................#..........#...............#......##...............#.#........###.......#.
            ..............#......#.....#.........#.....##....#..................#..##.......#.........##.#..##..................#....#.........
            ....#...#...##.......###.......#....#...........#.#.............#...#.............#.#...#.#..................#..#.........#........
            ................#.........#....#....#.##.....#...###..........#.......#...........#..#....#.............#....................##....
            .......................##..............#...#.#....##.#............#.#........#......##....#.......#........#.#.......#....#..#..#..
            ..#....#..#............#.#...................#.....................................#.......##.#............##..#........#..........
            .....#............#.......##.........##...#........#........................................#................#.......#..........#..
            ......#.#.....#.......#............##......#.#..#....#.........................#...............#..#.......##....###......###.......
            ..#...................#.#...#.....#.......#..................................#..#....#......#.#...#..#..#......#.#.#....#....#.....
            ...#....#....#.....#.....#.............................#.##..............#.....#..#.........#...#.....#........#.......#......##...
            .....#.......#.....#...#..#....#................#.......................#..#...#........#..........#....#..#....................#..
            ......#.............#.#...#.##.......#...#.....#.....#.#.#...............#.....##.#....#...............................#.#.....#...
            ...................................................................................................................................
    """.trimIndent(), 64
    )
    check(3677, result)
}

private fun test(input: String, stepsCount: Int): Int {
    val map = input.split("\n")

    val rows = map.indices
    val cols = map[0].indices

    var startPoint: Point? = null
    for (row in rows) {
        for (col in cols) {
            if (map[row][col] == 'S') {
                startPoint = Point(col, row)
                break
            }
        }
        if (startPoint != null) break
    }

    fun Point.next(): Set<Point> {
        return mutableSetOf<Point>().apply {
            this += plus(1, 0)
            this += plus(-1, 0)
            this += plus(0, 1)
            this += plus(0, -1)
        }
            .filter { it.x in cols && it.y in rows }
            .filter { map[it.y][it.x] == '.' }
            .toSet()
    }

    fun bfs(): Set<Point> {
        var opened = mutableSetOf<Point>()

        opened += startPoint!!
        var steps = 0

        while (opened.isNotEmpty()) {
            val achievable = mutableSetOf<Point>()
            for (currentPoint in opened) {
                val next = currentPoint.next()
                for (nextPoint in next) {
                    achievable += nextPoint
                }
            }
            opened = achievable

            ++steps

            println("step $steps")
            for (row in rows) {
                for (col in cols) {
                    if (Point(col, row) in achievable) {
                        print('O')
                    } else {
                        print(map[row][col])
                    }
                }
                println()
            }
            println()

            if (steps == stepsCount) {
                return achievable
            }
        }

        return emptySet()
    }

    return bfs().size + 1
}
