package advent.advent2024

import utils.Direction
import utils.Point
import utils.Position

private var result = 0

fun main() {
    result = test(
        """
            ....#.....
            .........#
            ..........
            ..#.......
            .......#..
            ..........
            .#..^.....
            ........#.
            #.........
            ......#...
    """.trimIndent()
    )
    check(6, result)

    result = test(
        """
            .......#.........#..............#........................#......#....#............................#..#...............#............
            ...................#.............................................#...................................#............................
            ...............#.................................##.........#..........#.....##...#...#.....#....#..................#.............
            #.............................................#..#.............#..........#.##.............................................#......
            #.........................................................#.....#........................................##.......................
            ...........#.......#.#...........#....#.#...#......................................#...........................#...##............#
            ........................................................#..#.....................................#..#................#....#...#...
            #.#.....#.........................#...........#.......................................#.......#.....................##............
            .......#..........##.....#........#..................................................#.........................................#.#
            #.#..............#.#.............................#............#....#...............#.........................#............#..#.#.#
            ..........................................................#....................................................#..................
            .......................#....#...........#.....................#....#...#.......#..............#.......................#...........
            ..............................#..............#.......#....................................#.....................#...#...#.........
            ........#.................#...#....##..............#...........................#............................#.................#...
            ..................#........................................#......#......................................................#........
            .............#.................#...#..............................................................................#...#...........
            .....................................#..........................................................#.#.#......#.........#............
            ..........#...................................................................#.........##.......#..#.............................
            ...#.#....................................#..#...........#.......................................................##...............
            ........................................................................................................#.........................
            .........#...........#......#..............#........#....................#...#......#.............................................
            ........#....#...............#....................#..........#.....................................#......#......#........#.#.....
            ........................#..........................#.......#........................#................#......#.....................
            ......................................#.........................................#............................#....................
            ...................................#.#...#...........#.........................................#.....................#............
            .................#....#.....................................................................#..................#.........#........
            ...........#...........................................................#.............................#...............#..#.........
            ..#.....................#.........................................................................................................
            ....................#....#.#...........................#...........................................#..............#...............
            ...#...................................................#.............................................#.........#..........#.......
            .............................###.....#..#..#......................................................................................
            ##................#.#.......#..............#.....#...............#..#............#................................................
            ......#...............................................#.#..#............................#............#.................#..........
            ........................................#.#...................................................#.....#.............................
            #.......#.#.......................#.....#....................................#...................#................................
            ...##................................................................................................#.....................#......
            ............#.............#..................#.................#..................................................................
            ...#..............#..............................................................................#..........#......#..............
            ...#..#...#................................................#.....................#......#......................#.......#..........
            .................#..#........#...............#.#................#......##.................#.................................#.....
            #.....#.......#...........................................#..........#..............................#...#.#..#......#.....#.......
            ....................................#.........#........#..................#.............................................#.........
            #...............................#........................#.................................................#.....#................
            ..#..................................#.......#.....................#..............................................................
            ........#...#.....................................#......#..............#..#..#..........................#.#....#.................
            .............#..........#....#................#.......#..........................................#.....#..........................
            .............................................#................................#.........................#...#.....................
            .........#........#...................................................................#.......#....#..............................
            ....................................#.......................#..............#...............................#......................
            ....#....................#................................#....#...........#.............#........................................
            ....#...........#...................#.#..................................................#.....................#..................
            ..........#....................#............#.##...#.......#....#...............#.....#...#.........................#.............
            .......#....................................................................................................#.................#...
            ...............................................................................#......#.................#...#.....................
            ..................#........#..........#..........................................................................#................
            ..........................................................................................#.......................................
            .#..#...........#.................................##...........................#.....#...................#..#.....................
            ........................#..#..........................................................#............#..................#..........#
            ...........#...................................................##...........................#...............................#.....
            ........#......................................................................................................#..................
            ........#..#............................#..#...........#..............................#......................#.##...........#....#
            ........#...#.#..............#...#.....................#....................#.#..............................#....................
            .......................................................#....................................................#..#..................
            ...........................................#......................#................#........................#....................#
            .............#...............#................................................................................#...................
            ..#...#............#.............#.....#........................#............#....................#...............................
            .....#...................................................................................................................#........
            ....................#..#...........#....#.............................................................................#.......#...
            ..............#......#.........................#...........#...#...........................................#...#..................
            ..............................#.....#.........................................................#......#.#......#...................
            ............................................................#...................#.#............................#..................
            .............###.#........................................#........................................................#..............
            ......#................................#...............##.........................................................................
            .........#.....#.#.....................#.......................................#...............#..........#....#....#.............
            ..............................................#....................................#...........................................#..
            ............#.#..........#........#..#.....#.............#..........#............#......#...................##..........#.........
            ............#....#...................................#.............................#.........................#....................
            .#..................................#....#.........................................................................#..............
            .........................#...#...#.................#..................#.............#.#...#...............#.......................
            .........#...............................#...........#.............................#...........................#..........#.......
            ......#..........................#.............#..........#.......................................................................
            .......#...............#.........#.............#...............................#..................................................
            ..#......#....................##...........................................#........................................#.............
            ..........................#.....#.......................#...........................................................#.#...........
            ..#....................#.............#................................................................#.#.........................
            .........#....................#.....#....#...............#.......................#........#.......................................
            ..............#...................................................................#................#...#..........................
            ....................#.....#.......#..#......................................#...........#..................................##....#
            .......#.......................................................................#..................................................
            ......#.............##..........................#..#......................^.......................................................
            ..............................#..........#...................#.................................#.....................#............
            .......................##..........................#.......#..............................#...................................#.#.
            ................#....................................................................#...............................#.........#..
            ..........................................#......#.....................................#................#........#................
            #......................................#.......................................................#..#...........#...................
            .......#.............#..................#..#...#............#.......#.....#.....#.#...............................................
            .............................#........#.............#.....#.......#...................................#.#..................#......
            .................#......................................................................................#........#..#.............
            ........................................................................#..............#.....#..............................#.....
            ....#....#..........................................#......##...#....................#...................#..........#.............
            .................##.......................##.#.........#................................................#.........................
            .#..............................................#.........................#.#.#..........#.....................................##.
            ............................................................#..........#....#...................................................#.
            ....#...........#.............................#.....................#.........#..................#...........................#....
            ......#.#.......#..#......#........#..#...................#....#..................................................................
            ............#........................................................................................................#............
            .....................................................#..........................................#................#................
            ...#.......#..#..............#.............................#....................................#.................................
            .................##.........#........................#....................................#...............#.#.#...................
            ................#......#......................#..#..........................................#.....................................
            ......#..................................................##.#.#........#...........................#.......................#......
            ........................#............#......#.........#.............#.............................................#.....#.##......
            ......................#........................................#.......#.........#.................#..#...........#...............
            ..#.......#.........##..#.#................................................................................#.........#............
            ........................................................................................#............#...........#................
            ................#...#....................#..##..#...............#.............................................................#...
            ...#........#..........................#.....#..........................#....................................#.........#.......##.
            .................#...........................#.........#......#............................#.....................#................
            ...................#..........#....#.......#...................#.............................#..........#.........................
            .......#..............#.................................#.........#....................................#.................#....##.#
            ..................................#.......................#....#..#.........................#....................#................
            .....#.........#............#...#.........#........#...................#...#......................#.....#............#............
            #.#....#...#........#................................##..........................#.............................##...#....#........
            .............##..........##...#......#.......#.#................#.#.......................#.............#.........................
            .............#....................................#....................................#..........................................
            ..................................#..............................#.......................................#................#.......
            ...................#...............#..............................................................................................
            ....#........#.................................#........#.....................................#.......#................#........#.
            .................#......#.......................................................##.....#..................#.......................
            ...............#.......................#.#........#...........................................#........#..........................
    """.trimIndent()
    )
    check(1915, result)
}

private fun test(input: String): Int {
    val map = input.split("\n")
    val height = map.size
    val width = map[0].length

    fun findStartPosition(): Position? {
        for (row in 0..<height) {
            for (col in 0..<width) {
                if (map[row][col] == '^') return Position(Point(row, col), Direction.U)
            }
        }
        return null
    }

    fun isInsideMap(point: Point): Boolean {
        return point.x in 0..<height && point.y in 0..<width
    }

    fun makeStep(map: List<String>, position: Position): Position {
        val point = position.point
        val direction = position.direction
        val nextPoint = when (direction) {
            Direction.D -> {
                Point(point.x + 1, point.y)
            }

            Direction.U -> {
                Point(point.x - 1, point.y)
            }

            Direction.L -> {
                Point(point.x, point.y - 1)
            }

            Direction.R -> {
                Point(point.x, point.y + 1)
            }
        }
        if (isInsideMap(nextPoint)) {
            if (map[nextPoint.x][nextPoint.y] == '#') {
                val nextDirection = when (direction) {
                    Direction.D -> {
                        Direction.L
                    }

                    Direction.U -> {
                        Direction.R
                    }

                    Direction.L -> {
                        Direction.U
                    }

                    Direction.R -> {
                        Direction.D
                    }
                }
                return Position(point, nextDirection)
            } else {
                return Position(nextPoint, direction)
            }
        } else {
            return Position(nextPoint, direction)
        }
    }

    var cycleCount = 0

    val start = findStartPosition()!!
    for (x in 0..<height) {
        for (y in 0..<width) {
            if (map[x][y] == '.') {
                val newMap = mutableListOf<String>()
                for (row in 0..<height) {
                    var rowString = ""
                    for (col in 0..<width) {
                        rowString += if (row == x && col == y) '#' else map[row][col]
                    }
                    newMap += rowString
                }

                val positions = mutableSetOf<Position>()
                var current = start
                while (isInsideMap(current.point)) {
                    positions += current
                    current = makeStep(newMap, current)
                    if (current in positions) {
                        ++cycleCount
                        break
                    }
                }
            }
        }
    }

    return cycleCount
}
