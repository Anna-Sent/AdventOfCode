package advent.advent2024

import utils.Direction
import utils.Point
import utils.Position
import kotlin.math.min

private var result = 0

fun main() {
    result = test(
        """
            ###############
            #.......#....E#
            #.#.###.#.###.#
            #.....#.#...#.#
            #.###.#####.#.#
            #.#.#.......#.#
            #.#.#####.###.#
            #...........#.#
            ###.#.#####.#.#
            #...#.....#.#.#
            #.#.#.###.#.#.#
            #.....#...#.#.#
            #.###.#.#.#.#.#
            #S..#.....#...#
            ###############
    """.trimIndent()
    )
    check(45, result)

    result = test(
        """
            #################
            #...#...#...#..E#
            #.#.#.#.#.#.#.#.#
            #.#.#.#...#...#.#
            #.#.#.#.###.#.#.#
            #...#.#.#.....#.#
            #.#.#.#.#.#####.#
            #.#...#.#.#.....#
            #.#.#####.#.###.#
            #.#.#.......#...#
            #.#.###.#####.###
            #.#.#...#.....#.#
            #.#.#.#####.###.#
            #.#.#.........#.#
            #.#.#.#########.#
            #S#.............#
            #################
    """.trimIndent()
    )
    check(64, result)

    result = test(
        """
            #############################################################################################################################################
            #.#.................#...........#.........#.....#.......#.......#.......#.........#.....#...#.................#.........#.......#..........E#
            #.#.###.###.#######.###.#####.###.#####.#.###.#.###.#.#.#.#.###.#.#####.#.#####.#.#.#.#.#.#.#.#########.#.#.#.#.###.###.#.###.#.###.###.#.###
            #...#.#.....#...#.......#...#.#...#.....#.....#.#...#.#...#...#.#.....#.#...#...#...#.#...#.#...#.......#.#.#.#...#.#...#.#...#...#.....#...#
            #.###.#.#.###.#.#########.#.###.###.###########.#.#.#.#######.#.#####.#####.#.#.#####.#####.#####.###.#.###.#.#####.#.###.#.#####.#.###.###.#
            #.#...#.......#...........#...#...#...#.#.........#.......#...#.....#.......#.#.....#.#.#...#.....#...#...#.#.......#.......................#
            #.###.#######################.###.###.#.#.###.#######.###.#.#######.#########.#####.#.#.#.###.#####.#.###.#.#########.#########.###.#########
            #.....#...............#.#.....#.#.#.#.#.....#...#...#.......#...#.......#...#.....#...#.....................#.......#...........#.....#.....#
            #####.#######.#######.#.#.###.#.#.#.#.#######.#.#.#.#.#######.#.#######.#.#.#####.#############.#.###.###.#.###.###.#.###########.#.#.#.###.#
            #...#.........#.....#.#.#.#.....#.#.#.........#.........................#.#.....#.#...#...#.....#.#.#.....#...#...#...#.......#...#.#...#.#.#
            ###.#############.###.#.#.#######.#.###.###.#.#.#.#.#.#.#.#######.#.#.###.#####.#.#.#.#.#.#####.#.#.#.#######.###.#.###.#####.#.###.#####.#.#
            #...#...#.........#...#.#.......#...#...........................#.#.#.#...#.......#.#...#...#...#.....#.......#...#.#.#.#...#...............#
            #.#.#.###.#####.###.###.#######.###.#.#######.#.#.#.#.###.###.#.#.#.#.#.###.#######.#######.#.#######.#.#######.###.#.#.#.#.#####.#.#.#.#.#.#
            #.#...#...#...#...................#.#.#.......#.#.#.#.........#.#.#...#.#.#...#...#.#.#...#.#.#.......#...............#.#.#.......#...#...#.#
            #.###.#.#####.#######.#.#.#.#.#.###.#.#.#####.#.#.#.#.###########.#.###.#.#.###.#.#.#.#.#.#.#.#.#######.###########.###.#.#########.#####.#.#
            #.#.#.#.....#.....#.....#.#...#.....#.#.......#...#.#.#.#.........#...#.#...#...#...#.#.#...#.#.#.......#...#...........#.....#.....#.#...#.#
            #.#.#.#####.#.###.#####.#.###########.#######.#####.#.#.#.###########.#.#####.#######.#.#####.#.#.###.###.#.#.#################.#####.#.###.#
            #.#.......#.#...#.....#.#...........#.#.......#...#...#.#...#...........#...#.........#.#...#...#.#...#...#.#...#.............#...#.#...#...#
            #.#########.#.#.#####.#.###########.#.#.#######.#.#.###.###.#.###########.#.#######.#.#.#.###.#####.###.###.###.#.#.#########.###.#.#.###.###
            #...........#.#.....#.#.#...........#.......#...#.#.....#...#.#...........#...#.....#...#.#...#...#.#...#.#...#.#.#...#.#.........#.....#...#
            #.###########.#####.#.###.#####.#############.###.#######.#####.#############.#.#####.###.#.###.#.#.#.###.###.#.#####.#.#.#########.#######.#
            #...#.......#.#.#...#...#.#...#.#...........#.#.#.#.....#.#...#.#.........#...#.#...#...#.#...#.#.#.#.......#.............#...#...#.#.....#.#
            ###.#.###.###.#.#.#####.#.#.#.###.#########.#.#.#.#.#.#.#.#.#.#.#.###.###.#.###.#.#.###.#.###.#.#.#.#.#########.#####.###.#.#.#.#.#.#.###.#.#
            #.#.#...#.......#.....#.#...#...#...#.#.....#.#...#.#.....#.#...#...#.#...#.....#.#...#.#...#...#.#...#.......#.#.....#...#.#.#.#...#...#.#.#
            #.#.###.###########.#.#.#######.###.#.#.#####.#.###.#.#####.#######.#.#############.###.#.#######.###.#.#####.###.###.#.#.#.#.#########.#.#.#
            #.#...#...#.#.......#.......#.....#.#.........#.....#...#...#...#...#.......#.......#...#...#...#...#.#.#.......#.#.....#...#.....#.....#...#
            #.###.###.#.#.#############.#.#####.#.#################.#.###.#.#.#########.#.#.###.#.###.#.#.#.###.###.#######.#.#.#############.#.#########
            #...#.#.#...#.........#.....#.#...#.......#.......#...#.#.....#.#.#...#...#...#.#...#.#...#...#...#...#.#.....#...#...#...#.......#.........#
            #.###.#.###.#########.###.###.#.#.#######.#.#####.#.#.#.#####.#.###.#.#.#.#####.#####.#.#####.#.#####.#.#.###.#######.#.#.#.#######.#######.#
            #...#.#.#...#.....#.#...#.#...#.#.#.....#.#.....#...#...#...#.#...#.#...#.....#.....#.#.......#.........#...#.#...#.....#.#...#...#.#.....#.#
            ###.#.#.#.#.#.###.#.###.#.#.#.#.#.#.###.#.#####.#########.#.#####.#.#.#######.#.###.#.#####.#####.#########.#.#.#.#.#####.###.###.#.###.#.#.#
            #...#.#...#.....#.....#.#.....#.#...#.....#.......#...#...#.......#.#.#...#.#.#...#.....#...#...#...#.....#.#...#...#...#.#.#...#.......#.#.#
            #.#.#.#.###.###.#.#.###.#####.#.###########.#######.#.#.###########.#.#.#.#.#.#####.###.#####.#.#####.###.#.#########.###.#.###.#########.#.#
            #.#...#.#.....#.#...#...#...#.#.........#.#.#...#...#...#...........#...#.#...........#.......#.......#.#.#...#...#...........#.#.....#...#.#
            #.#.###.#.#.#.#.#.#.#.#.#.#.###########.#.#.###.#.#######.#####.###.#.###.#######.#####################.#.###.###.#.#######.###.#.###.#.###.#
            #...............#.#.#.....#.........#...#.......#...#...#.#...#...#.....#.......#.#.........#.#.........#.#...#...#...#.#.....#.#...........#
            #.#.#.###.#.#####.#.#.###.#####.#####.#.#####.#.###.#.#.###.#.#########.#######.###.#####.#.#.#.#.#.###.#.#.###.#####.#.#.###.#.###.#.#####.#
            #.#.......#.......#.#...#.....#...#...#.#...#.....#...#.....#.........#.......#.........#.#.#.#.#.#...#.#.#.#...#...#.#.....#...#...#.#.....#
            #.#.#######.#######.###.#.#.#####.#.#####.#.#####.###################.#.#######.#########.#.#.#.#.###.###.#.#.###.#.#.#####.#####.###.#.#####
            #.#.......#.#.....#...#...#.#...#.#.#...#.#.#.#...#.......#.........#.#.#.....#.#...#...#.#...#.#...#...#...#.#...#.#.....#.......#.....#...#
            #.#.#####.#.#.###.###.###.###.#.#.#.#.#.#.#.#.#.###.###.#.#######.###.#.#.###.###.#.#.#.#.###.#.#.#.###.#####.#.###.#####.###.###########.#.#
            #...#...#...#.......#...#.#...#...#...#...#.#.#.#.#.#...#.......#.#...#.#.#.#.....#...#.#...#.#...#...#...#.....#.#...#...#...#...........#.#
            ###.#.#####.#.###.#.###.#.#.#####.#########.#.#.#.#.#.#.#######.#.#.#####.#.#####.#####.#.#.###.#####.###.#.#####.###.#.#####.#.###.#####.#.#
            #...#.......#.#...#.#.....#.#...#.#.....#...#...#...#.#.#.....#...#.....#.........#...#.#.#...............#.#...#.#...#.....#.#.#.......#...#
            #.#.#####.#.###.#####.#####.#.#.#.#####.#.###.###.#.#.###.###.#####.###.#.#########.#.#.#.#############.#.#.#.#.#.#.#######.###.#####.#.#.###
            #.#...#...#.....#...#...#...#.#.......#.#.#.#.#.....#...#.#.......#.#.#.#.#.....#...#.#.#...#.......#...#.#...#...#.#.........#...#...#.#...#
            #.#.#.#.#.#.#.###.#.###.#.#.#########.#.#.#.#.#.#####.#.#.#######.#.#.#.#.#.#.#.#.###.#.#####.#####.#.#########.###.#.###.###.###.#.#####.#.#
            #.......#.....#...#.........#.....#.#.#.#.#.#.#.....#...#...#...#.#.#.#.#.....#.....#.#.......#.#...#...........#.......#...#.....#.........#
            #.#######.#####.#########.###.###.#.#.#.#.#.#.#.###.#.#.###.#.#.#.#.#.#.#.###.#######.#########.#.#######.#.#####.#.###.###.#######.#####.###
            #...#...#.....#.......#.......#.#.#.#...#.#.#.#.....#.#...#.#.#...#...#...#.#.#.#.....#...#.....#.........#.#...#.#...#.#.#.......#.....#...#
            #.#.#.#.###.#######.###.#######.#.#.#.###.#.#.#.###.#.###.#.#.###.###.###.#.#.#.#.#######.#.#.#####.#####.#.###.#.#####.#.###.###.#####.#.#.#
            #.#...#...#.#.....#.#...#.......#.#.#.#...#.#...#.#.#...#.#.....#.#.#...#.#.....#.......#...#...........#.#.....#...........#.#.#.#.#...#.#.#
            #.#######.#.#.###.#.#.###.###.###.#.#.#.###.#####.#.###.#.#####.#.#.###.#.#####.#######.#.#########.#####.#####.#############.#.#.#.#.#.#.#.#
            #.....#.....#.#.#...#...#.#.#.......#.#.#.........#.....#.#.....#.#...#.#...#.#...#...#.#.......#.#...#...#.....#.........#...#.#...#...#.#.#
            #####.#.###.#.#.#######.#.#.#.#.###.#.#.###.#.###########.#.#####.#.#.#.###.#.###.#.#.#.#######.#.###.#.###.###.#.#####.#.#.###.#.#.###.#.###
            #...#.#.#...#.#.....#.#.#.#.#.#.#.....#...#.#.........#...#...#...#.#...#...#...#...#.#...#...#.....#.#.....#.....#.....#.#.#...#...#...#...#
            #.#.#.#.#####.#.###.#.#.#.#.#.#.#######.#.#####.###.###.#####.#.#########.###.#####.#.###.###.#####.#.#.#######.###.###.#.#.###.#.###.###.#.#
            #.#.#.#.....#.#.#.......#.#...#.#.......#.....#.#.#.........#.#...#.......#.#...#...#.#...#...#.....#...#.........#...#.......#...#...#.....#
            #.###.#####.#.#.#######.#.#####.#.###.#.#####.#.#.#.#.###.###.###.#.#######.#.#.#.#.#.#.###.###.#########.#######.###.#.#####.#.#.#.#####.#.#
            #.......#...#.#.....#...#...#...#.#.#.#.#...#.#.#.#.....#.#...#.....#.....#.#.#...#...#.#...#...#...#.....#.....#.#...#.....#.#.#...#.....#.#
            #.#######.#.#.#.###.#.#####.#.###.#.#.#.#.###.#.#.#.###.###.###.###.#.###.#.#.#########.###.#.###.#.#.#########.#.#.#.#####.#.#.#.###.#####.#
            #...#.....#.#.#...#.#.....#.......#.#.#.#.#.......#...#...#...#.#...#.#.....#.....#...#...#.#.#...#.#.....#.....#...#...#...#.#.#.#.......#.#
            ###.#.#####.#.###.#.#####.###.###.#.#.#.#.#.#########.###.###.###.#.#.#.#########.#.#.###.#.#.#####.#####.#.###.#######.###.#.###.#.#####.###
            #...........#...#.#.....#...#.#...#.#.#...#.................#.#...#.#.#.#.........#.#...#.#.#.#.......#...#...#.......#...#...#...#.#...#...#
            #.#####.#.#.###.#.###.#.###.###.#.#.#.###.#######.#.###.###.#.#.###.#.###.#########.###.#.#.#.#.#####.#.###.#.#######.###.#####.###.#.#####.#
            #...#...#.....#.#.....#...#...#.#...#.#...#.......#...#.#.#.#...#...#...#.#...#.....#.#...#.....#.....#...#.#.#.........#...#...#.#.#.....#.#
            ###.#.#####.###.#####.#.#####.#.#.#.#.#####.#########.#.#.#.#####.#.###.#.###.#.#####.#.#######.#####.###.###.#########.###.#.###.#.#.#.#.#.#
            #.#.....#.#.#...#...#.#.....#...#.#.#.......#.....#...#.#.#.......#...#.....#.#.........#...#...#...#...#...#.........#...#.............#.#.#
            #.#.###.#.#.#.#.#.#.#######.#####.#.#.#######.#.###.###.#.#######.###.#####.#.#.#.###.###.#.#####.#.#.#####.#########.###.#####.#.#####.###.#
            #.....#.#...#.#...#.......#.#.....#...#...#...#.......#...#.#...#...#...#.#.#.#.#.#.......#.#.....#.#.#.....#.........#.......#.#...#...#...#
            #.#####.#.#.#.###.#######.#.#.#########.#.#####.#.#.#####.#.#.#.#.#.###.#.#.#.#.###.#######.#.###.#.###.#.#.#.#.###.###.###.#.#.###.#.###.#.#
            #.#.....#.#.......#.....#.#.#.........#.#.#...#...#.......#.#.#.#.#.#.#.#...#.#.....#.........#...#.....#...#.........#...#...#...#.#.#...#.#
            #.#.#######.#######.###.#.#.#########.#.#.#.#.#####.###.###.#.#.#.#.#.###.###.###########.#####.#########.#.#####.#.#.#.###.###.#.#.#.#.#####
            #.#.#...#.....#.....#.#.#.........#...#.#...#.#...#.........#.#...#...#...#...#.......#...#...........#...#.#...#.#...#...#...#.#.....#.#...#
            ###.#.#.#.#####.#####.#.###########.###.#####.#.#.#########.#.#.#######.###.###.#.###.#.#.#.#######.#.#.###.#.#.#.#.#####.###.#####.###.#.#.#
            #...#.#...#.....#.....#.#...........#...#.#...#.#.........#.#.#.#...#...#...#...#...#...#.#.....#...#.#...#...#.#.#.#.......#...#.....#...#.#
            #.###.#####.#####.#.#.#.#.#######.###.###.#.###.###.#######.#.###.#.#.###.###.#####.#####.###.###.#.#####.#####.###.#.#.###.###.#.#.#.#####.#
            #.....#...#.#.#...#.#.#.#.....#...#...#...#.....#.#.........#.#...#.#...#.....#...#...#...#...#...#.#...#.....#.....#.#.#.....#...#.#.#...#.#
            #.#######.#.#.#.#.#.#.#.###.#.#.###.#####.#######.###########.#.###.###.#.#####.#.#.#.#.###.#.#.#####.#.###.#.#######.#.###########.#.#.#.#.#
            #...#.....#.#.....#.#.#...#.#.#...#.#.......#...#.......#...#...#.#.....#.#.....#.#.#.#.#...#...#...#.#.#.....#.....#.#.#...........#.#.#.#.#
            ###.#.#####.#######.#.###.###.###.#.#.#####.#.#.###.###.#.#.#####.#########.#####.###.#.#.#.#####.#.#.#.#.#.###.#.###.#.#.###.#####.#.#.#.#.#
            #...#.#...#...#...#.#.......#.....#...#...#...#.....#...#.#...#.#...............#.....#.#.#.....#.#.#.#...#.#...#.#...#.#.#...#...#.#...#...#
            #.###.#.#.###.#.#.#.#.#.###.#.#.#.#####.#.###########.###.###.#.#.#.#.###.#.#.#.#######.#.#####.#.#.#.#.#####.###.#.###.#.#.###.#.#.#####.#.#
            #.....#.#...#...#.#...#.....#.#.#...#...#.......#...#...#.....#...#.....#...#.#.#.....#.#.#.......#.#...#.....#.#.#.#.#...#.#...#.#.#.....#.#
            #####.#.###.###.#.#.#####.#####.###.#.#####.#####.#.###.#.#.###.#######.#####.#.###.#.#.###.#.#.###.###.#.#####.#.#.#.#####.#.#.#.#.#.#.#.#.#
            #.#...#.....#.....#.....#.......#...#.#...#.......#.....#.#.#.........#.......#...#.#.....#.#.#...#...#...#.....#...#...#.....#.#.#...#.#...#
            #.#.#####.#.#.#########.###.#.#######.#.#.#########.#.###.#.#############.#######.#######.#.#.#####.#.#####.#########.#.#.###.#.###.###.#.###
            #.........#...#...#...#...#.#.#.......#.#.......#.....#...#.............#.....#...#.....#...#.......#.#.......#.......#.#...#.#...#.......#.#
            #.#####.#######.#.###.###.#.###.#########.#.###.#.#####.###############.#######.###.###.#############.#.#####.#.#####.#.###.#.#.#.#.#####.#.#
            #.#.#...#.......#...#.....#...#.........#.#.#...#.....#...#.#.........#.#.....#.....#...#.............#.....#...#...#.#...#...#.#.....#.#.#.#
            #.#.#.#.#.#########.#####.###.#########.###.#.###.###.#.#.#.#.#######.#.#.###.#######.###.###############.#.#####.#.#.###.###.#.###.#.#.#.#.#
            #...#.#.#.#...#...#.....#.#...#.......#.#...#.....#...#.#.#.....#.#...#...#...#.......#...#...............#.#...#.#.#...#...#.......#.#.#.#.#
            ###.#.#.#.#.###.#.#####.#.#.#.#.#.#####.#.###.###.#.###.#.#####.#.#.#######.###.#######.###.#.###########.###.#.#.#.#.#.#######.#.#.#.#.#.#.#
            #...#.#.#.#.....#.....#.#...#.#.#.#.....#.#.....#.#.....#...#...#.#.#.....#.#...#.....#...#.#.#.........#...#.#...#.#.#.#.........#.#...#.#.#
            #.###.#.#.#######.###.#.###.###.#.#.#####.#####.###.#####.#.#.###.#.#.###.#.#.###.###.###.###.#.###.###.###.#.#####.###.#.#####.###.###.#.#.#
            #...#.#.#.#...#...#...#...#.#...#...#...#...#.....#.#.......#.#...#...#.#...#.......#.#.#.....#...#.....#...#.#...#...#.#.#...#.#...#.#.#.#.#
            #####.#.#.#.#.#.#########.#.#.#########.#.#.#####.###.#######.#.#######.#######.#####.#.#####.#######.#.#.###.#.#####.#.#.#.#.#.#.###.#.#.#.#
            #.....#...........#...#...#.#...#.......#.#.....#.....#.......................#.#.....#...#...#.....#.#...#...#.....#...#.#.#.....#...#.#...#
            #.###.#.#####.#.#.#.#.#.###.###.#####.###.#####.###.###.###########.#####.###.###.#####.###.###.###.#.#####.###.#.#.###.#.#.###.###.###.#.#.#
            #.....#...#.#.#.#.#.#...#.#.#.#.#...#.#...#...#.#.....#...........#...#.#.#.#.....#.....#...#.#.#.#.#.....#.#...#.#.......#.#...............#
            #.###.###.#.#.###.#.#####.#.#.#.#.#.#.#.#####.#.#.###############.###.#.#.#.###########.#.###.#.#.#.#####.#.#.#.###.#####.###.#.#.###.#.#.#.#
            #...#.#.#...#.......#.....#...#.#.#.#.....#...#.#...#...........#.#.....#.#.............#.#...#.#.#.#.....#.#.#...#...#.#.......#.#...#.#...#
            #.###.#.###.#####.#.#####.###.#.#.#.#####.#.###.#.#.#.#####.#####.#.#####.#.#.#####.#####.###.#.#.#.#.#####.#.###.###.#.#########.#.###.#.#.#
            #.#...#...#...#...#.....#.#...#...#...#...#...#...#.#.#...#...#...#...#...#.#.......#.....#...#.#...#.......#.....#.........................#
            ###.#.#.#.###.#.#######.#.#.###.#####.###.###.###.#.#.#.#.###.#.###.###.###.#####.#.#.#####.#.#.###.#######.###.#.###########.###.#########.#
            #...#...#.#...#...#...#.#.#...#.....#...#...#...#.#.....#.#.#.#.#...#...#.#...#.#.#.#...#...#.#...#.#.........#.#...........#...#.#.....#...#
            #.###.#.###.#####.#.#.#.#.###.#.#.#.###.###.#.###.#######.#.#.#.#####.###.###.#.#.###.#.#.#######.#.#########.#.#########.#.#.#.###.###.#.#.#
            #.....#.....#.....#.#...#.#...#.#.#.#...#.#.#.#...#...#.....#.#...#...#.....#...#.......#...#.....#.......#...#.#...........#.#.#...#...#...#
            #.###.#.#####.#####.#####.#.###.#.#.#.###.#.#.#.###.#.#####.#.###.#.###.#######.###########.#.#.#########.#.###.###.###########.#.###.#####.#
            #.......#.....#.#...#.......#...#.#.#...#...#.......#...#...#...#...#.........#.....#.....#.#.#.#.....#...#...#...#...#.....#...#...#.....#.#
            #.#.#.###.#####.#.#.#.###########.#.###.#.###.#########.#######.#####.#######.###.#.#.#.#.#.#.###.###.###.#####.#.###.#.###.#.#.#.#.###.#.#.#
            #...#...#.......#...#...........#.#...#.#.........#...#.......#.....#.......#...#.#...#.#.#.#.......#...#.....#.#.#...#...#...#.#.#.#.#.#.#.#
            #.###.#.###.#######.###########.#.#####.#.#########.#.###.###.#.#.#.#######.###.#.###.#.#.#.#.#########.#####.###.#.#####.#####.#.#.#.#.###.#
            #.#.......#.#.......#.....#.......#.....#.#.....#...#...#...#.#.#.#.........#...#...#.#.#.....#.........#...#.#.....#.....#...#.#.#...#.....#
            #.#.#.#####.#.#######.###.#######.#.#######.#.#.#.#####.#####.#.#.###########.###.#.###.#####.#.#########.###.#.###.#.#####.#.#.#.###.#.###.#
            #.#.....#...#...#...#.#.#.#...#...#...#.....#.....#...#.......#...#.........#.#...#.....#...#.#...#...#.......#.#.#.#.#.....#.#.#...#...#...#
            #.#####.#.#####.#.#.#.#.#.#.#.#.#####.#.#############.#.#######.#####.#######.#.#.#########.#.#.#.#.###.#######.#.#.#.###.#####.#.#.#.#.###.#
            #...#.#.#.#...#...#.#...#...#.#.#...#.#.#.......#...#.....#.#...#...#...#.....#.#...#.....#.#.#.#.#.............#...#...#.#...#.#.....#.....#
            ###.#.#.#.#.#.#####.###.#####.###.#.#.#.#.#.###.#.#.#.###.#.#.###.#.###.#.#####.#.#.###.#.#.#.#.#.#######.#####.###.###.#.#.#.#.#.###.#####.#
            #.#...#.#...#.....#...#.#...#.#...#.#.#.#.#.....#.#.#.#.....#.....#.....#.......#.#.....#.#.#...#.....#.#.....#...#.....#...#.#.#...#...#...#
            #.###.#.#####.#####.###.#.#.#.#.###.#.#.#.#.#####.#.#.###.###.#.###.###.#########.#######.#.###.###.#.#.#####.###.#######.###.#.#.#.#.#.#.###
            #...#.#.......#...#.....#.#.#.#...#.#.#...#.#.....#.#...#.#.....#.......#.........#.....#.....#.#...#.#.....#...#...#.....#.#...#.....#.#.#.#
            #.#.#.#########.#.#.###.#.#.#.#.###.#.#.###.#.#####.#.#.###.#.###.#######.#######.#.###.#######.#.#.#.#.###.###.#.#.#.#####.#####.###.#.#.#.#
            #.#...#.#.......#.....#.#.#.#...#...#.#.....#.#.....#.......#.....#.....#.#.......#.#.#.......#.#.#.#.#...#...#.#.#.#...#.............#.#.#.#
            #.#####.#.###.#####.#.###.#.###.#.###.#.#####.#.###############.###.###.#.#.#######.#.#######.#.#.#.#.###.#.#.#.#.#.###.###.#.###.###.#.#.#.#
            #.#.....#...#.#...#.......#...#.#...#.#.#.#...#.#...............#...#.#...#.#.......#.......#...#...#...#.#.#.#.#.#.#...#...#.#.....#...#...#
            #.#.#.#.###.###.#.#.#########.#####.#.#.#.#.#.#.###.#########.###.###.#.#####.###.#.#####.#.#####.#####.#.#.###.###.#.###.#####.###.#####.#.#
            #.#.#.#.#.#.....#...#.....#...#.....#...#...#.#.....#.............#.#...#.....#.#.#.......#.#.........#.#.#.........#.....#.......#.#.......#
            #.#.#.#.#.#######.#.#.###.#.###.###.#.###.###.#######.#############.#.###.#.###.#.#.###.###.#######.#.#.#################.#.#.#####.#.###.###
            #.#.#.#...#.......#...#.#.#.....#...#...#.#.#.#.........#.....#.....#.#.#.......#...#.....#.......#.#.#...#.............#.#...#.#...#.#.....#
            #.###.###.#####.#.#.###.#.#######.#.#.#.#.#.#.#.#########.###.###.###.#.###.###.###.#.#.#.#######.###.###.#.###########.#####.#.#.#.#.###.#.#
            #.....#...#...#.#.#.....#.#.....#.#.....#.........................#...#.#.....#.#.#...#.#.......#...#.#...#.....#...#.#.....#...#.#.#.#...#.#
            #######.###.#.###.#.###.#.#.###.#.#.#######.#.#.#.###.#.###.###.#.#.###.#.#.###.#.#####.#####.#.###.#.#.#######.#.#.#.#####.###.#.###.#.#.#.#
            #...............#.....#.#.#.....#...#.....#.#.#.#.#.#...#.....#.#.......#.#...#...#.....#...#.#...#...#.....#...#.#.......#.....#.....#.#...#
            #.###.#########.#.#.###.#.###.#.###.#.#.###.#.#.#.#.#######.#.#.#######.#.#.#.###.#.###.#.#.#.#######.###.###.###.#######.#############.#.#.#
            #...#...#.......#...#...#...#.#...............#.#.........#.#.#.....#...#...#...#.#...#...#...#.....#.#.................#.....#.......#.....#
            ###.#####.#######.#.#.#.###.###.###.#.#######.###########.#.#######.#.#.###.#.###.###.#.#####.#.###.#.#.###.###.###.#.#######.#.#####.#.#.#.#
            #...#...#...#.....#...#.#.#...#...#.#...#...#.#.....#...#.#.......#...#.#...#.#...#...#...#...#.#.#.#.#.....#...#...#.#.....#...#...#.#.#...#
            #.###.#.###.#.###.#.###.#.###.#.#.#.###.###.#.#.###.#.#.#.#######.#####.#.#.#.#.###.#.###.#####.#.#.#.#####.#.#.#.#####.###.#####.#.#.###.#.#
            #S....#.......#.............#...#...........#.....#...#...............#.....#.......#...#.........#.............#.........#.......#.......#.#
            #############################################################################################################################################
    """.trimIndent()
    )
    check(527, result)
}

private fun test(input: String): Int {
    val map = input.split("\n")
    val height = map.size
    val width = map[0].length

    fun findStart(): Position {
        for (x in 0..<height) {
            for (y in 0..<width) {
                if (map[x][y] == 'S') {
                    return Position(Point(x, y), Direction.R)
                }
            }
        }
        throw IllegalStateException()
    }

    fun isInsideMap(point: Point): Boolean {
        return point.x in 0..<height && point.y in 0..<width
    }

    fun Position.generateNext(path: List<Position>): Set<Position> {
        val results = mutableSetOf<Position>()
        val nextDirections = when (direction) {
            Direction.L, Direction.R -> listOf(direction, Direction.U, Direction.D)
            Direction.U, Direction.D -> listOf(direction, Direction.R, Direction.L)
        }
        for (nextDirection in nextDirections) {
            val nextPoint = when (nextDirection) {
                Direction.D -> Point(point.x + 1, point.y)
                Direction.U -> Point(point.x - 1, point.y)
                Direction.L -> Point(point.x, point.y - 1)
                Direction.R -> Point(point.x, point.y + 1)
            }
            if (isInsideMap(nextPoint) && map[nextPoint.x][nextPoint.y] in setOf(
                    '.', 'E'
                ) && path.all { it.point != nextPoint }
            ) {
                val nextPosition = Position(nextPoint, nextDirection)
                results += nextPosition
            }
        }
        return results
    }

    fun List<Position>.score(): Int {
        val path = this
        var score = 0
        for (i in 1..<path.size) {
            if (path[i].direction != path[i - 1].direction) {
                score += 1000
            }
            if (path[i].point != path[i - 1].point) {
                ++score
            }
        }
        return score
    }

    var minScore = Int.MAX_VALUE
    val paths = mutableListOf<List<Position>>()
    val cache = mutableMapOf<Position, Int>()
    fun dfs(currentPath: List<Position>) {
        val last = currentPath.last()
        if (map[last.point.x][last.point.y] == 'E') {
            val currentPathScore = currentPath.score()
            paths += currentPath
            minScore = min(minScore, currentPathScore)
        } else {
            val next = last.generateNext(currentPath)
            for (nextPosition in next) {
                val newPath = mutableListOf<Position>()
                newPath += currentPath
                newPath += nextPosition
                val newScore = newPath.score()
                if (nextPosition in cache && cache[nextPosition]!! < newScore) {
                    continue
                } else {
                    cache[nextPosition] = newScore
                }
                if (newScore > minScore) {
                    continue
                }
                dfs(newPath)
            }
        }
    }

    dfs(listOf(findStart()))
    return paths.filter { it.score() == minScore }
        .map { it.map { item -> item.point }.toList() }
        .flatten()
        .toSet().size
}
