package advent.advent2023

import utils.Point
import utils.plus

private var result = 0L

fun main() {
    result = test(
        """
            ...................................................................................................................................
            .#....................#..#......##.#..#.#..#.#..#.#.........#....................##......##...#....#.....#..#.....#........#.......
            .........#......#.#.........#...#.#...##..#.......#..#...................#........#..........#.#..##...#...#.......................
            ..#...#...#..#..#.#..#......#.....#...#....##..............................#......#.....#........#.......#.#.......#..#......#.....
            ............#................#...#.............#.........................#..................#....#..............#......##..#.......
            .##....#...#....#............#.#..................#.#...#.................#......#.....#..........#.....#.#.#...........#..........
            ..###....#.#.#....#....##............##.#...#...............................#.#..#.#.........#....................#.#....###.#.....
            ..#....##.......#...##..#......#.....................#..........#...#............#.........#.........##......#......#..#......#....
            ....................#......##.............#.#.................................#.....#..#.#..#....#...##........#....#..............
            ................#...........#.#.....#.#....#.................#.....#...................#..............#....#..#......#......#......
            .....#.....#...........#.............#.##......#.#..............#................#........#..#..#....#....#....#.#..........#.#....
            ..#......#..........#.............#..........#...#.................#.##..................#.##.....#......##.......#...#.........##.
            .......#..#..#.......#.......#...##.#....#.....#...........#...#....#..#..............#.............#......#..#....................
            ..#..#.........#.......#...#..............#.............#......#....#...................#..........##.....##.##.....#.....#.#......
            .....#....###....#......#..#..#..#........#..#............#.....#.....#.#.#..................#.......#...........##................
            .........#....#.....#...........#..##..##.......................#..#.......#.............#....##...##...#...#...##........#...#....
            .#...#..#.....#.......#.#......#.......#.#.............#..#.#.....#.#.#......#.........#.........#...........#..#.....##....#......
            .....#.#.#...............#...........###.#..............#.#..#......#...................#...#....##.........#..#..#.#...#.#........
            ......#..........#....##.....#.......#.....#..........#......###....#.......#...........#......#..............#.........#..#.#.....
            ...#......#............#............#.#..#........#.....#.......#..............#.............#.........#...........#...............
            ..............##........#.##..#....................#.......#...............#...#.............#...#..##.........#.......#.........#.
            ..........##....#..#.........#...#..............#.....##..#.....................#...........##.......................#...........#.
            ......#..........##..............#...................#...#..#.....#.....#.......#...............#.........#..#......#........#.....
            ....#.#.............#.....#...#.....#.#........#.#...#...###..#........#..#...#.............#.........#.....................##.....
            ....#...#.........#..............#..............#.......####.........#..............##...........###.......#.....#........##..#..#.
            ..#...#...........#.#...#...#...............................#............#....................#...#....#..#...#.#...........#..#...
            ..#.....##..#.#.........................................#.........#....#......#....#..#....................#.#........#..........#.
            ..#...#..#...#......#.#.......#...............#.#......##..#..#.........#.............#......................#....##...##.#........
            ...#.#.#..............#...##..............#...#............#...............#...........#.#.........#..#.......#.#.#...........#....
            ............#.....#....#.....##...............#......#..........#.....#........#........#..............#...#.#.....#.#.............
            ............#........##.................#......#...............................#.#.#................#...#.................#..#.....
            ......#...#....#............#.........#.......#....#...................#........#..........#...............#...........#...........
            ........#............#......##.......#...........#.......#.............#.....................................#...........#.........
            ..........#.....#.........#.#.......................#..........##.........#....#........#.....#..........##..................##....
            ..........#........................#.............#.......##..#......#..........#...........#.............#....#..#..#....#......#..
            ......#........#........#.........#.......#....#..................#.........##.....#......#....................#...#.........#.....
            ...#..#....#....#.................#...#.....#.....##....................#.......##.....#...#...##.......................##.....#...
            ...##........#.....................#.........#..##....#.................###........#.......#..............#...#...#.......#....##..
            .......#...........##.............#......##.............##.##........##...#..#..#.#.......#..#.#...........#...#...................
            .........#.......##.............#............##.....#........#...............#.#.....#.....#.#..............#.......##...#.........
            .......##...#....#...........#...........#..............#..#..#.........####..........#....##.................#..............#.....
            ....#..........................#..........#.............#..........#...#...........#.......#............................##.........
            ...#...#.....###.................................##...............................#....#...#..##.................................#.
            ..#....#.#......#............#...#......##.....#.....#..##...#.........#.....#.............#......#...#............#...............
            ......#.....#.##................#.......##.##........#.........................#..............................................#....
            .#....#..................#.#...............#..#......##.......##...............#....####..........#...#........................#...
            ...#........#..........#.................#....#.........#....#.....#.........#.....#.#.......##.......#................#..##.......
            .#.......#.#..#............##...........#......#.#.......................#.........#.....#.....#.....###...............#.#..##.....
            .......................#...#...........#.........#....###.......................#.........###.#.#....#......#........##............
            ..#....................#.................#.#.##.#........#..#......#....#......##......#............#..#..............#....#....#..
            .......................##.##.#..#.....###....#..#.#...#............#........#.....#....#.#.....#..#....#......................##...
            ....#.....#.........##..#....#..#.........#...#...#..##........#......###.....#..................#......................#..........
            .#.#................#..#.#...#........................#....##..#.............#...#.#.......#........#.#.....##................#....
            .##..#..........#..#.#........##............#.......#..........#....#.#...#....##.#...#..##...........#.......................#....
            .#.#.##..................#............#.#......#.........#............#.#....#..#.........##..#..................##...........##.#.
            ..............#..........#...#...##..........#.....................#..#..............#.....#.#...........#.....#....#.......#......
            ..###.........#........###...#...........#..##.##..###....#...#................#.....#......#...##...................#...........#.
            ..#...........#.................##........#.........#...#.....##......##...#.........#......#.............#...#..#.................
            ..#.............#..........#.#.............#.....#............#....#.#......#....................#.#.......#.#.....#............##.
            ..........#...........#...#...#...#................#......#................#..........................##.##.....#..#..#.#..........
            ..............#....#......#............#.....#.......#..#..........................#..#...............................#............
            ............#.............#...........##...#.##..#.........#....#.....#..#.....#...............##....#.................#...........
            ...........#.....#.##..............#....#..........#......#.......#..##....##.......#.........#.......#....#...#..........#........
            ......#...#...#..............#.#...##.#..#........#.....#.......#...#.........#.....#.....##.........#.#...........................
            ..............#..#........#......##.......#......#...#.#........#.............#...##.............#.#.#...............##....#.......
            .................................................................S.................................................................
            .........#.....#.#.#..........#.#.............#..#.....................##......##.#.............#.#.......#.........#...#..........
            .........#......#......#......#..........#...........................#...#......#..........#..#.#..........#......#..#..#...#......
            ........#.#...............##...............................#.#..............#.#....##..#...#...#....#..#.................#.........
            .............#..#....#............#........#.#......#........#.......#....#......#...#.#..........#....##......#.#.................
            ............#..........#.............#.#..............#.....#.....#...#...#........#.#........#.#........#.#.......................
            .................#........#......#....#.#................#..............#.....#.#.....#.............#.#........#.#...#.............
            ...........#....#.##...........#..#...................................#.#...#........#.......#.........#...#..##..##...............
            .....................#.#..#...#.#..........#....##...#.................#...............#.......................#...................
            ..............#..#.............#.#...........#....#.......#.........#.......#.........#...#.#.........##............#..............
            ....#.............##....#......#..........................##.........#.#.........#.....#...#..............#........................
            ....#............#...........#.####....#...#.......#..#.........#...#.............#...........#...#...........#.##...........#.#...
            ..##..............#...............#...#.#..#....##.....................#..#.....#.............#....#.......#..###.............##.#.
            .....#.##........#....#...##.#..###...#......#..##.#.....#..#.#.#........##......#............#.......#.....#....#...........##....
            .#......................#.#.......#........#.#.#.........##.....#.....#..#........#..#..#...#..##.......#...............#..........
            .....#...#.............................#.....#.....#......##......#...##........#.#.........................###.........#..........
            ...#........#...................#....#...........#..#....#...#.........#...........##.#..#..#..#...........##............#.........
            ......##..#..........##..#..#...........#......#...#........#.....#........#...........#........#............#........#.......#....
            .......#.......................#....#......###..#..#..#.........#.##..#................#.....#...............................#.....
            ...#.........#............................................#...#....#...........#.#..................#.....##.......#...#........#..
            ..##..###.......#........#................#.....#..................##.........#..#..#...........#..##...###.........###...#...#....
            ..........#.....#.............#.#..#.#...........##.........#..............................#..#.......#.#................#.#.#.....
            .......#..................#............##.............#..............#.#........#.#..............#...#..........................#..
            ...#.......#.....#..........................#...#...#...........#..#.............#.........#..........#.............#........#.....
            ..............#................##......#.#......#........................####...#.....#....#....#..................#.#.#........#..
            ........#.....#.#....#....................##......................................#...#..#.......#..........................##.....
            ...#.#.........#.#..#.............#...#....##.......#......................##...#.#.........#.....#..........#.....................
            ..#.#......#...#......##............#......#....#.#..#.#..........#....#......##..#................................#...............
            ........###..##....##...........................#.#.#.##..###........#....#............#........##.........#...#...................
            ....#............................#.#.........#.........#...#.......#.................#..#......#.........#..#.....#...#.#....#...#.
            ..#.#..........#..........#.........#..#...#..........#.....#....................#.#..#.......#...........#............#...........
            .......#.....#...........##.........#.....#..........#....#..#......#...........#...##....#......................#....#.......#....
            ..##......#...##.............................##..........#....#..............#..........#..............##..#....##.#........##.....
            ....#......#....#.#..................#..........#....#.#..##.#.##........#.............................#...............#.......#.#.
            .............#..#......#.................#.#..#....####........#......#......#....#.#.....................#.#.#.#..#...............
            .##......#........##........#.............#.#.###.....#.............#.......#..##....#...#....................##..###.......#......
            ....#.#......##.#.......#......#......................#.......#.........#..#...........#................#.........#..#...#....#....
            ..........#....#..#...........#.................#...#..#.....................#.#........##.......#.#....#..#................##...#.
            ......#....#.......#.......#..#...........#......#............#......#................#..........#...#.......##...#....#.#.........
            ...#..##...##....#..#.......#....#.................#.#.....#....#........#..#.....####.#...........#..#............#...#..##.....#.
            ..#......#...................#...............................#............#.....##.............#..#...#..##.#......#...............
            ....#.........#.........#..............................#...#....#..#.#..............#...............#..##.........#.......#....#...
            .....#.........#....#.............#............................#.................##............#...#......#..........#.....#.....#.
            ...#.#....#.......##...#....#............................##.#...#.......#...##...................#..........#.#....................
            ...........#..#.###.....##...#.........#...........#..#.#.........#.#.#.......#.................#....#............###.........#..#.
            .##..........#..#......#.....##.##.#...##.........#.................#....#.#.....#.................#.....#...#....#.....###..#.#...
            ......#.#..##.#.......#...#..#........................#..#..........#.#....#..##........#...#.#.............#.#....................
            .......#.#.............#..#.........................#.##..........##......................#...##.........#....#..........#..###....
            ...............#..#...#.........#.........#.................#.#......#....................#.........#.......................#.#....
            .....#.................#.#...............##............................####...................##....#......#.#....##..#..#.......#.
            ....#..#.......#.#...#.......................##.........#..#.......#.#.#............#...........#.###............#......#...##.....
            ..#.#..........#..#.......#...#.........#....#.........#....#...#.......#.#..........##..##........................#..........##...
            ....#...##......##......#.......#....###..............................#.##........................#......##.......#............#...
            ...........#......#.#......#.............................#..........#...............#......##...............#.#........###.......#.
            ..............#......#.....#.........#.....##....#..................#..##.......#.........##.#..##..................#....#.........
            ....#...#...##.......###.......#....#...........#.#.............#...#.............#.#...#.#..................#..#.........#........
            ................#.........#....#....#.##.....#...###..........#.......#...........#..#....#.............#....................##....
            .......................##..............#...#.#....##.#............#.#........#......##....#.......#........#.#.......#....#..#..#..
            ..#....#..#............#.#...................#.....................................#.......##.#............##..#........#..........
            .....#............#.......##.........##...#........#........................................#................#.......#..........#..
            ......#.#.....#.......#............##......#.#..#....#.........................#...............#..#.......##....###......###.......
            ..#...................#.#...#.....#.......#..................................#..#....#......#.#...#..#..#......#.#.#....#....#.....
            ...#....#....#.....#.....#.............................#.##..............#.....#..#.........#...#.....#........#.......#......##...
            .....#.......#.....#...#..#....#................#.......................#..#...#........#..........#....#..#....................#..
            ......#.............#.#...#.##.......#...#.....#.....#.#.#...............#.....##.#....#...............................#.#.....#...
            ...................................................................................................................................
    """.trimIndent()
    )
    check(609585229256084, result)
}

private fun test(input: String): Long {
    val map = input.split("\n")

    val rows = map.indices
    val cols = map[0].indices

    var startPoint: Point? = null
    for (row in map.indices) {
        for (col in map[0].indices) {
            if (map[row][col] == 'S') {
                startPoint = Point(col, row)
                break
            }
        }
        if (startPoint != null) break
    }

    val size = map.size

    fun Point.next(): Set<Point> {
        return mutableSetOf<Point>().apply {
            this += plus(1, 0)
            this += plus(-1, 0)
            this += plus(0, 1)
            this += plus(0, -1)
        }
            .filter { it.x in cols && it.y in rows }
            .filter { map[it.y][it.x] != '#' }
            .toSet()
    }

    fun bfs(startPoint: Point, stepsCount: Int): Int {
        var opened = mutableSetOf<Point>()

        opened += startPoint
        var steps = 0

        while (opened.isNotEmpty()) {
            val achievable = mutableSetOf<Point>()
            for (currentPoint in opened) {
                val next = currentPoint.next()
                for (nextPoint in next) {
                    achievable += nextPoint
                }
            }
            opened = achievable

            ++steps

            if (steps == stepsCount) {
                return achievable.size
            }
        }

        return 0
    }

    startPoint!!

    val areas = 26501365 / size - 1
    val evenAreas = ((areas + 1) / 2 * 2) * ((areas + 1) / 2 * 2).toLong()
    val oddAreas = (areas / 2 * 2 + 1) * (areas / 2 * 2 + 1).toLong()

    var sum = 0L

    sum += evenAreas * bfs(startPoint, size * 2)
    sum += oddAreas * bfs(startPoint, size * 2 + 1)

    sum += bfs(Point(startPoint.x, 0), size - 1)
    sum += bfs(Point(0, startPoint.y), size - 1)
    sum += bfs(Point(startPoint.x, size - 1), size - 1)
    sum += bfs(Point(size - 1, startPoint.y), size - 1)

    sum += (areas + 1) * bfs(Point(0, 0), size / 2 - 1)
    sum += (areas + 1) * bfs(Point(0, size - 1), size / 2 - 1)
    sum += (areas + 1) * bfs(Point(size - 1, 0), size / 2 - 1)
    sum += (areas + 1) * bfs(Point(size - 1, size - 1), size / 2 - 1)

    sum += areas * bfs(Point(0, 0), size * 3 / 2 - 1)
    sum += areas * bfs(Point(0, size - 1), size * 3 / 2 - 1)
    sum += areas * bfs(Point(size - 1, 0), size * 3 / 2 - 1)
    sum += areas * bfs(Point(size - 1, size - 1), size * 3 / 2 - 1)

    return sum
}
