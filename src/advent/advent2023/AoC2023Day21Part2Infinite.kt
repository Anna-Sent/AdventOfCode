package advent.advent2023

import utils.Point
import utils.plus
import kotlin.math.abs

private var result = 0L

fun main() {
    result = test(
        """
            ...........
            .....###.#.
            .###.##..#.
            ..#.#...#..
            ....#.#....
            .##..S####.
            .##..#...#.
            .......##..
            .##.#.####.
            .##..##.##.
            ...........
    """.trimIndent(), 6, true
    )
    check(16, result)

    result = test(
        """
            ...........
            .....###.#.
            .###.##..#.
            ..#.#...#..
            ....#.#....
            .##..S####.
            .##..#...#.
            .......##..
            .##.#.####.
            .##..##.##.
            ...........
    """.trimIndent(), 10
    )
    check(50, result)

    result = test(
        """
            ...........
            .....###.#.
            .###.##..#.
            ..#.#...#..
            ....#.#....
            .##..S####.
            .##..#...#.
            .......##..
            .##.#.####.
            .##..##.##.
            ...........
    """.trimIndent(), 50
    )
    check(1594, result)

    result = test(
        """
            ...........
            .....###.#.
            .###.##..#.
            ..#.#...#..
            ....#.#....
            .##..S####.
            .##..#...#.
            .......##..
            .##.#.####.
            .##..##.##.
            ...........
    """.trimIndent(), 100
    )
    check(6536, result)

    result = test(
        """
            ...........
            .....###.#.
            .###.##..#.
            ..#.#...#..
            ....#.#....
            .##..S####.
            .##..#...#.
            .......##..
            .##.#.####.
            .##..##.##.
            ...........
    """.trimIndent(), 500
    )
    check(167004, result)

    result = test(
        """
            ...........
            .....###.#.
            .###.##..#.
            ..#.#...#..
            ....#.#....
            .##..S####.
            .##..#...#.
            .......##..
            .##.#.####.
            .##..##.##.
            ...........
    """.trimIndent(), 1000
    )
    check(668697, result)

    result = test(
        """
            ...........
            .....###.#.
            .###.##..#.
            ..#.#...#..
            ....#.#....
            .##..S####.
            .##..#...#.
            .......##..
            .##.#.####.
            .##..##.##.
            ...........
    """.trimIndent(), 5000
    )
    check(16733044, result)

    result = test(
        """
            ...................................................................................................................................
            .#....................#..#......##.#..#.#..#.#..#.#.........#....................##......##...#....#.....#..#.....#........#.......
            .........#......#.#.........#...#.#...##..#.......#..#...................#........#..........#.#..##...#...#.......................
            ..#...#...#..#..#.#..#......#.....#...#....##..............................#......#.....#........#.......#.#.......#..#......#.....
            ............#................#...#.............#.........................#..................#....#..............#......##..#.......
            .##....#...#....#............#.#..................#.#...#.................#......#.....#..........#.....#.#.#...........#..........
            ..###....#.#.#....#....##............##.#...#...............................#.#..#.#.........#....................#.#....###.#.....
            ..#....##.......#...##..#......#.....................#..........#...#............#.........#.........##......#......#..#......#....
            ....................#......##.............#.#.................................#.....#..#.#..#....#...##........#....#..............
            ................#...........#.#.....#.#....#.................#.....#...................#..............#....#..#......#......#......
            .....#.....#...........#.............#.##......#.#..............#................#........#..#..#....#....#....#.#..........#.#....
            ..#......#..........#.............#..........#...#.................#.##..................#.##.....#......##.......#...#.........##.
            .......#..#..#.......#.......#...##.#....#.....#...........#...#....#..#..............#.............#......#..#....................
            ..#..#.........#.......#...#..............#.............#......#....#...................#..........##.....##.##.....#.....#.#......
            .....#....###....#......#..#..#..#........#..#............#.....#.....#.#.#..................#.......#...........##................
            .........#....#.....#...........#..##..##.......................#..#.......#.............#....##...##...#...#...##........#...#....
            .#...#..#.....#.......#.#......#.......#.#.............#..#.#.....#.#.#......#.........#.........#...........#..#.....##....#......
            .....#.#.#...............#...........###.#..............#.#..#......#...................#...#....##.........#..#..#.#...#.#........
            ......#..........#....##.....#.......#.....#..........#......###....#.......#...........#......#..............#.........#..#.#.....
            ...#......#............#............#.#..#........#.....#.......#..............#.............#.........#...........#...............
            ..............##........#.##..#....................#.......#...............#...#.............#...#..##.........#.......#.........#.
            ..........##....#..#.........#...#..............#.....##..#.....................#...........##.......................#...........#.
            ......#..........##..............#...................#...#..#.....#.....#.......#...............#.........#..#......#........#.....
            ....#.#.............#.....#...#.....#.#........#.#...#...###..#........#..#...#.............#.........#.....................##.....
            ....#...#.........#..............#..............#.......####.........#..............##...........###.......#.....#........##..#..#.
            ..#...#...........#.#...#...#...............................#............#....................#...#....#..#...#.#...........#..#...
            ..#.....##..#.#.........................................#.........#....#......#....#..#....................#.#........#..........#.
            ..#...#..#...#......#.#.......#...............#.#......##..#..#.........#.............#......................#....##...##.#........
            ...#.#.#..............#...##..............#...#............#...............#...........#.#.........#..#.......#.#.#...........#....
            ............#.....#....#.....##...............#......#..........#.....#........#........#..............#...#.#.....#.#.............
            ............#........##.................#......#...............................#.#.#................#...#.................#..#.....
            ......#...#....#............#.........#.......#....#...................#........#..........#...............#...........#...........
            ........#............#......##.......#...........#.......#.............#.....................................#...........#.........
            ..........#.....#.........#.#.......................#..........##.........#....#........#.....#..........##..................##....
            ..........#........................#.............#.......##..#......#..........#...........#.............#....#..#..#....#......#..
            ......#........#........#.........#.......#....#..................#.........##.....#......#....................#...#.........#.....
            ...#..#....#....#.................#...#.....#.....##....................#.......##.....#...#...##.......................##.....#...
            ...##........#.....................#.........#..##....#.................###........#.......#..............#...#...#.......#....##..
            .......#...........##.............#......##.............##.##........##...#..#..#.#.......#..#.#...........#...#...................
            .........#.......##.............#............##.....#........#...............#.#.....#.....#.#..............#.......##...#.........
            .......##...#....#...........#...........#..............#..#..#.........####..........#....##.................#..............#.....
            ....#..........................#..........#.............#..........#...#...........#.......#............................##.........
            ...#...#.....###.................................##...............................#....#...#..##.................................#.
            ..#....#.#......#............#...#......##.....#.....#..##...#.........#.....#.............#......#...#............#...............
            ......#.....#.##................#.......##.##........#.........................#..............................................#....
            .#....#..................#.#...............#..#......##.......##...............#....####..........#...#........................#...
            ...#........#..........#.................#....#.........#....#.....#.........#.....#.#.......##.......#................#..##.......
            .#.......#.#..#............##...........#......#.#.......................#.........#.....#.....#.....###...............#.#..##.....
            .......................#...#...........#.........#....###.......................#.........###.#.#....#......#........##............
            ..#....................#.................#.#.##.#........#..#......#....#......##......#............#..#..............#....#....#..
            .......................##.##.#..#.....###....#..#.#...#............#........#.....#....#.#.....#..#....#......................##...
            ....#.....#.........##..#....#..#.........#...#...#..##........#......###.....#..................#......................#..........
            .#.#................#..#.#...#........................#....##..#.............#...#.#.......#........#.#.....##................#....
            .##..#..........#..#.#........##............#.......#..........#....#.#...#....##.#...#..##...........#.......................#....
            .#.#.##..................#............#.#......#.........#............#.#....#..#.........##..#..................##...........##.#.
            ..............#..........#...#...##..........#.....................#..#..............#.....#.#...........#.....#....#.......#......
            ..###.........#........###...#...........#..##.##..###....#...#................#.....#......#...##...................#...........#.
            ..#...........#.................##........#.........#...#.....##......##...#.........#......#.............#...#..#.................
            ..#.............#..........#.#.............#.....#............#....#.#......#....................#.#.......#.#.....#............##.
            ..........#...........#...#...#...#................#......#................#..........................##.##.....#..#..#.#..........
            ..............#....#......#............#.....#.......#..#..........................#..#...............................#............
            ............#.............#...........##...#.##..#.........#....#.....#..#.....#...............##....#.................#...........
            ...........#.....#.##..............#....#..........#......#.......#..##....##.......#.........#.......#....#...#..........#........
            ......#...#...#..............#.#...##.#..#........#.....#.......#...#.........#.....#.....##.........#.#...........................
            ..............#..#........#......##.......#......#...#.#........#.............#...##.............#.#.#...............##....#.......
            .................................................................S.................................................................
            .........#.....#.#.#..........#.#.............#..#.....................##......##.#.............#.#.......#.........#...#..........
            .........#......#......#......#..........#...........................#...#......#..........#..#.#..........#......#..#..#...#......
            ........#.#...............##...............................#.#..............#.#....##..#...#...#....#..#.................#.........
            .............#..#....#............#........#.#......#........#.......#....#......#...#.#..........#....##......#.#.................
            ............#..........#.............#.#..............#.....#.....#...#...#........#.#........#.#........#.#.......................
            .................#........#......#....#.#................#..............#.....#.#.....#.............#.#........#.#...#.............
            ...........#....#.##...........#..#...................................#.#...#........#.......#.........#...#..##..##...............
            .....................#.#..#...#.#..........#....##...#.................#...............#.......................#...................
            ..............#..#.............#.#...........#....#.......#.........#.......#.........#...#.#.........##............#..............
            ....#.............##....#......#..........................##.........#.#.........#.....#...#..............#........................
            ....#............#...........#.####....#...#.......#..#.........#...#.............#...........#...#...........#.##...........#.#...
            ..##..............#...............#...#.#..#....##.....................#..#.....#.............#....#.......#..###.............##.#.
            .....#.##........#....#...##.#..###...#......#..##.#.....#..#.#.#........##......#............#.......#.....#....#...........##....
            .#......................#.#.......#........#.#.#.........##.....#.....#..#........#..#..#...#..##.......#...............#..........
            .....#...#.............................#.....#.....#......##......#...##........#.#.........................###.........#..........
            ...#........#...................#....#...........#..#....#...#.........#...........##.#..#..#..#...........##............#.........
            ......##..#..........##..#..#...........#......#...#........#.....#........#...........#........#............#........#.......#....
            .......#.......................#....#......###..#..#..#.........#.##..#................#.....#...............................#.....
            ...#.........#............................................#...#....#...........#.#..................#.....##.......#...#........#..
            ..##..###.......#........#................#.....#..................##.........#..#..#...........#..##...###.........###...#...#....
            ..........#.....#.............#.#..#.#...........##.........#..............................#..#.......#.#................#.#.#.....
            .......#..................#............##.............#..............#.#........#.#..............#...#..........................#..
            ...#.......#.....#..........................#...#...#...........#..#.............#.........#..........#.............#........#.....
            ..............#................##......#.#......#........................####...#.....#....#....#..................#.#.#........#..
            ........#.....#.#....#....................##......................................#...#..#.......#..........................##.....
            ...#.#.........#.#..#.............#...#....##.......#......................##...#.#.........#.....#..........#.....................
            ..#.#......#...#......##............#......#....#.#..#.#..........#....#......##..#................................#...............
            ........###..##....##...........................#.#.#.##..###........#....#............#........##.........#...#...................
            ....#............................#.#.........#.........#...#.......#.................#..#......#.........#..#.....#...#.#....#...#.
            ..#.#..........#..........#.........#..#...#..........#.....#....................#.#..#.......#...........#............#...........
            .......#.....#...........##.........#.....#..........#....#..#......#...........#...##....#......................#....#.......#....
            ..##......#...##.............................##..........#....#..............#..........#..............##..#....##.#........##.....
            ....#......#....#.#..................#..........#....#.#..##.#.##........#.............................#...............#.......#.#.
            .............#..#......#.................#.#..#....####........#......#......#....#.#.....................#.#.#.#..#...............
            .##......#........##........#.............#.#.###.....#.............#.......#..##....#...#....................##..###.......#......
            ....#.#......##.#.......#......#......................#.......#.........#..#...........#................#.........#..#...#....#....
            ..........#....#..#...........#.................#...#..#.....................#.#........##.......#.#....#..#................##...#.
            ......#....#.......#.......#..#...........#......#............#......#................#..........#...#.......##...#....#.#.........
            ...#..##...##....#..#.......#....#.................#.#.....#....#........#..#.....####.#...........#..#............#...#..##.....#.
            ..#......#...................#...............................#............#.....##.............#..#...#..##.#......#...............
            ....#.........#.........#..............................#...#....#..#.#..............#...............#..##.........#.......#....#...
            .....#.........#....#.............#............................#.................##............#...#......#..........#.....#.....#.
            ...#.#....#.......##...#....#............................##.#...#.......#...##...................#..........#.#....................
            ...........#..#.###.....##...#.........#...........#..#.#.........#.#.#.......#.................#....#............###.........#..#.
            .##..........#..#......#.....##.##.#...##.........#.................#....#.#.....#.................#.....#...#....#.....###..#.#...
            ......#.#..##.#.......#...#..#........................#..#..........#.#....#..##........#...#.#.............#.#....................
            .......#.#.............#..#.........................#.##..........##......................#...##.........#....#..........#..###....
            ...............#..#...#.........#.........#.................#.#......#....................#.........#.......................#.#....
            .....#.................#.#...............##............................####...................##....#......#.#....##..#..#.......#.
            ....#..#.......#.#...#.......................##.........#..#.......#.#.#............#...........#.###............#......#...##.....
            ..#.#..........#..#.......#...#.........#....#.........#....#...#.......#.#..........##..##........................#..........##...
            ....#...##......##......#.......#....###..............................#.##........................#......##.......#............#...
            ...........#......#.#......#.............................#..........#...............#......##...............#.#........###.......#.
            ..............#......#.....#.........#.....##....#..................#..##.......#.........##.#..##..................#....#.........
            ....#...#...##.......###.......#....#...........#.#.............#...#.............#.#...#.#..................#..#.........#........
            ................#.........#....#....#.##.....#...###..........#.......#...........#..#....#.............#....................##....
            .......................##..............#...#.#....##.#............#.#........#......##....#.......#........#.#.......#....#..#..#..
            ..#....#..#............#.#...................#.....................................#.......##.#............##..#........#..........
            .....#............#.......##.........##...#........#........................................#................#.......#..........#..
            ......#.#.....#.......#............##......#.#..#....#.........................#...............#..#.......##....###......###.......
            ..#...................#.#...#.....#.......#..................................#..#....#......#.#...#..#..#......#.#.#....#....#.....
            ...#....#....#.....#.....#.............................#.##..............#.....#..#.........#...#.....#........#.......#......##...
            .....#.......#.....#...#..#....#................#.......................#..#...#........#..........#....#..#....................#..
            ......#.............#.#...#.##.......#...#.....#.....#.#.#...............#.....##.#....#...............................#.#.....#...
            ...................................................................................................................................
    """.trimIndent(), 64
    )
    check(3677, result)

    result = test(
        """
            ...................................................................................................................................
            .#....................#..#......##.#..#.#..#.#..#.#.........#....................##......##...#....#.....#..#.....#........#.......
            .........#......#.#.........#...#.#...##..#.......#..#...................#........#..........#.#..##...#...#.......................
            ..#...#...#..#..#.#..#......#.....#...#....##..............................#......#.....#........#.......#.#.......#..#......#.....
            ............#................#...#.............#.........................#..................#....#..............#......##..#.......
            .##....#...#....#............#.#..................#.#...#.................#......#.....#..........#.....#.#.#...........#..........
            ..###....#.#.#....#....##............##.#...#...............................#.#..#.#.........#....................#.#....###.#.....
            ..#....##.......#...##..#......#.....................#..........#...#............#.........#.........##......#......#..#......#....
            ....................#......##.............#.#.................................#.....#..#.#..#....#...##........#....#..............
            ................#...........#.#.....#.#....#.................#.....#...................#..............#....#..#......#......#......
            .....#.....#...........#.............#.##......#.#..............#................#........#..#..#....#....#....#.#..........#.#....
            ..#......#..........#.............#..........#...#.................#.##..................#.##.....#......##.......#...#.........##.
            .......#..#..#.......#.......#...##.#....#.....#...........#...#....#..#..............#.............#......#..#....................
            ..#..#.........#.......#...#..............#.............#......#....#...................#..........##.....##.##.....#.....#.#......
            .....#....###....#......#..#..#..#........#..#............#.....#.....#.#.#..................#.......#...........##................
            .........#....#.....#...........#..##..##.......................#..#.......#.............#....##...##...#...#...##........#...#....
            .#...#..#.....#.......#.#......#.......#.#.............#..#.#.....#.#.#......#.........#.........#...........#..#.....##....#......
            .....#.#.#...............#...........###.#..............#.#..#......#...................#...#....##.........#..#..#.#...#.#........
            ......#..........#....##.....#.......#.....#..........#......###....#.......#...........#......#..............#.........#..#.#.....
            ...#......#............#............#.#..#........#.....#.......#..............#.............#.........#...........#...............
            ..............##........#.##..#....................#.......#...............#...#.............#...#..##.........#.......#.........#.
            ..........##....#..#.........#...#..............#.....##..#.....................#...........##.......................#...........#.
            ......#..........##..............#...................#...#..#.....#.....#.......#...............#.........#..#......#........#.....
            ....#.#.............#.....#...#.....#.#........#.#...#...###..#........#..#...#.............#.........#.....................##.....
            ....#...#.........#..............#..............#.......####.........#..............##...........###.......#.....#........##..#..#.
            ..#...#...........#.#...#...#...............................#............#....................#...#....#..#...#.#...........#..#...
            ..#.....##..#.#.........................................#.........#....#......#....#..#....................#.#........#..........#.
            ..#...#..#...#......#.#.......#...............#.#......##..#..#.........#.............#......................#....##...##.#........
            ...#.#.#..............#...##..............#...#............#...............#...........#.#.........#..#.......#.#.#...........#....
            ............#.....#....#.....##...............#......#..........#.....#........#........#..............#...#.#.....#.#.............
            ............#........##.................#......#...............................#.#.#................#...#.................#..#.....
            ......#...#....#............#.........#.......#....#...................#........#..........#...............#...........#...........
            ........#............#......##.......#...........#.......#.............#.....................................#...........#.........
            ..........#.....#.........#.#.......................#..........##.........#....#........#.....#..........##..................##....
            ..........#........................#.............#.......##..#......#..........#...........#.............#....#..#..#....#......#..
            ......#........#........#.........#.......#....#..................#.........##.....#......#....................#...#.........#.....
            ...#..#....#....#.................#...#.....#.....##....................#.......##.....#...#...##.......................##.....#...
            ...##........#.....................#.........#..##....#.................###........#.......#..............#...#...#.......#....##..
            .......#...........##.............#......##.............##.##........##...#..#..#.#.......#..#.#...........#...#...................
            .........#.......##.............#............##.....#........#...............#.#.....#.....#.#..............#.......##...#.........
            .......##...#....#...........#...........#..............#..#..#.........####..........#....##.................#..............#.....
            ....#..........................#..........#.............#..........#...#...........#.......#............................##.........
            ...#...#.....###.................................##...............................#....#...#..##.................................#.
            ..#....#.#......#............#...#......##.....#.....#..##...#.........#.....#.............#......#...#............#...............
            ......#.....#.##................#.......##.##........#.........................#..............................................#....
            .#....#..................#.#...............#..#......##.......##...............#....####..........#...#........................#...
            ...#........#..........#.................#....#.........#....#.....#.........#.....#.#.......##.......#................#..##.......
            .#.......#.#..#............##...........#......#.#.......................#.........#.....#.....#.....###...............#.#..##.....
            .......................#...#...........#.........#....###.......................#.........###.#.#....#......#........##............
            ..#....................#.................#.#.##.#........#..#......#....#......##......#............#..#..............#....#....#..
            .......................##.##.#..#.....###....#..#.#...#............#........#.....#....#.#.....#..#....#......................##...
            ....#.....#.........##..#....#..#.........#...#...#..##........#......###.....#..................#......................#..........
            .#.#................#..#.#...#........................#....##..#.............#...#.#.......#........#.#.....##................#....
            .##..#..........#..#.#........##............#.......#..........#....#.#...#....##.#...#..##...........#.......................#....
            .#.#.##..................#............#.#......#.........#............#.#....#..#.........##..#..................##...........##.#.
            ..............#..........#...#...##..........#.....................#..#..............#.....#.#...........#.....#....#.......#......
            ..###.........#........###...#...........#..##.##..###....#...#................#.....#......#...##...................#...........#.
            ..#...........#.................##........#.........#...#.....##......##...#.........#......#.............#...#..#.................
            ..#.............#..........#.#.............#.....#............#....#.#......#....................#.#.......#.#.....#............##.
            ..........#...........#...#...#...#................#......#................#..........................##.##.....#..#..#.#..........
            ..............#....#......#............#.....#.......#..#..........................#..#...............................#............
            ............#.............#...........##...#.##..#.........#....#.....#..#.....#...............##....#.................#...........
            ...........#.....#.##..............#....#..........#......#.......#..##....##.......#.........#.......#....#...#..........#........
            ......#...#...#..............#.#...##.#..#........#.....#.......#...#.........#.....#.....##.........#.#...........................
            ..............#..#........#......##.......#......#...#.#........#.............#...##.............#.#.#...............##....#.......
            .................................................................S.................................................................
            .........#.....#.#.#..........#.#.............#..#.....................##......##.#.............#.#.......#.........#...#..........
            .........#......#......#......#..........#...........................#...#......#..........#..#.#..........#......#..#..#...#......
            ........#.#...............##...............................#.#..............#.#....##..#...#...#....#..#.................#.........
            .............#..#....#............#........#.#......#........#.......#....#......#...#.#..........#....##......#.#.................
            ............#..........#.............#.#..............#.....#.....#...#...#........#.#........#.#........#.#.......................
            .................#........#......#....#.#................#..............#.....#.#.....#.............#.#........#.#...#.............
            ...........#....#.##...........#..#...................................#.#...#........#.......#.........#...#..##..##...............
            .....................#.#..#...#.#..........#....##...#.................#...............#.......................#...................
            ..............#..#.............#.#...........#....#.......#.........#.......#.........#...#.#.........##............#..............
            ....#.............##....#......#..........................##.........#.#.........#.....#...#..............#........................
            ....#............#...........#.####....#...#.......#..#.........#...#.............#...........#...#...........#.##...........#.#...
            ..##..............#...............#...#.#..#....##.....................#..#.....#.............#....#.......#..###.............##.#.
            .....#.##........#....#...##.#..###...#......#..##.#.....#..#.#.#........##......#............#.......#.....#....#...........##....
            .#......................#.#.......#........#.#.#.........##.....#.....#..#........#..#..#...#..##.......#...............#..........
            .....#...#.............................#.....#.....#......##......#...##........#.#.........................###.........#..........
            ...#........#...................#....#...........#..#....#...#.........#...........##.#..#..#..#...........##............#.........
            ......##..#..........##..#..#...........#......#...#........#.....#........#...........#........#............#........#.......#....
            .......#.......................#....#......###..#..#..#.........#.##..#................#.....#...............................#.....
            ...#.........#............................................#...#....#...........#.#..................#.....##.......#...#........#..
            ..##..###.......#........#................#.....#..................##.........#..#..#...........#..##...###.........###...#...#....
            ..........#.....#.............#.#..#.#...........##.........#..............................#..#.......#.#................#.#.#.....
            .......#..................#............##.............#..............#.#........#.#..............#...#..........................#..
            ...#.......#.....#..........................#...#...#...........#..#.............#.........#..........#.............#........#.....
            ..............#................##......#.#......#........................####...#.....#....#....#..................#.#.#........#..
            ........#.....#.#....#....................##......................................#...#..#.......#..........................##.....
            ...#.#.........#.#..#.............#...#....##.......#......................##...#.#.........#.....#..........#.....................
            ..#.#......#...#......##............#......#....#.#..#.#..........#....#......##..#................................#...............
            ........###..##....##...........................#.#.#.##..###........#....#............#........##.........#...#...................
            ....#............................#.#.........#.........#...#.......#.................#..#......#.........#..#.....#...#.#....#...#.
            ..#.#..........#..........#.........#..#...#..........#.....#....................#.#..#.......#...........#............#...........
            .......#.....#...........##.........#.....#..........#....#..#......#...........#...##....#......................#....#.......#....
            ..##......#...##.............................##..........#....#..............#..........#..............##..#....##.#........##.....
            ....#......#....#.#..................#..........#....#.#..##.#.##........#.............................#...............#.......#.#.
            .............#..#......#.................#.#..#....####........#......#......#....#.#.....................#.#.#.#..#...............
            .##......#........##........#.............#.#.###.....#.............#.......#..##....#...#....................##..###.......#......
            ....#.#......##.#.......#......#......................#.......#.........#..#...........#................#.........#..#...#....#....
            ..........#....#..#...........#.................#...#..#.....................#.#........##.......#.#....#..#................##...#.
            ......#....#.......#.......#..#...........#......#............#......#................#..........#...#.......##...#....#.#.........
            ...#..##...##....#..#.......#....#.................#.#.....#....#........#..#.....####.#...........#..#............#...#..##.....#.
            ..#......#...................#...............................#............#.....##.............#..#...#..##.#......#...............
            ....#.........#.........#..............................#...#....#..#.#..............#...............#..##.........#.......#....#...
            .....#.........#....#.............#............................#.................##............#...#......#..........#.....#.....#.
            ...#.#....#.......##...#....#............................##.#...#.......#...##...................#..........#.#....................
            ...........#..#.###.....##...#.........#...........#..#.#.........#.#.#.......#.................#....#............###.........#..#.
            .##..........#..#......#.....##.##.#...##.........#.................#....#.#.....#.................#.....#...#....#.....###..#.#...
            ......#.#..##.#.......#...#..#........................#..#..........#.#....#..##........#...#.#.............#.#....................
            .......#.#.............#..#.........................#.##..........##......................#...##.........#....#..........#..###....
            ...............#..#...#.........#.........#.................#.#......#....................#.........#.......................#.#....
            .....#.................#.#...............##............................####...................##....#......#.#....##..#..#.......#.
            ....#..#.......#.#...#.......................##.........#..#.......#.#.#............#...........#.###............#......#...##.....
            ..#.#..........#..#.......#...#.........#....#.........#....#...#.......#.#..........##..##........................#..........##...
            ....#...##......##......#.......#....###..............................#.##........................#......##.......#............#...
            ...........#......#.#......#.............................#..........#...............#......##...............#.#........###.......#.
            ..............#......#.....#.........#.....##....#..................#..##.......#.........##.#..##..................#....#.........
            ....#...#...##.......###.......#....#...........#.#.............#...#.............#.#...#.#..................#..#.........#........
            ................#.........#....#....#.##.....#...###..........#.......#...........#..#....#.............#....................##....
            .......................##..............#...#.#....##.#............#.#........#......##....#.......#........#.#.......#....#..#..#..
            ..#....#..#............#.#...................#.....................................#.......##.#............##..#........#..........
            .....#............#.......##.........##...#........#........................................#................#.......#..........#..
            ......#.#.....#.......#............##......#.#..#....#.........................#...............#..#.......##....###......###.......
            ..#...................#.#...#.....#.......#..................................#..#....#......#.#...#..#..#......#.#.#....#....#.....
            ...#....#....#.....#.....#.............................#.##..............#.....#..#.........#...#.....#........#.......#......##...
            .....#.......#.....#...#..#....#................#.......................#..#...#........#..........#....#..#....................#..
            ......#.............#.#...#.##.......#...#.....#.....#.#.#...............#.....##.#....#...............................#.#.....#...
            ...................................................................................................................................
    """.trimIndent(), 26501365
    )
    check(609585229256084, result)
}

private fun test(input: String, stepsCount: Int, print: Boolean = false): Long {
    val map = input.split("\n")

    val rows = map.indices
    val cols = map[0].indices

    var startPoint: Point? = null
    for (row in rows) {
        for (col in cols) {
            if (map[row][col] == 'S') {
                startPoint = Point(col, row)
                break
            }
        }
        if (startPoint != null) break
    }

    val width = map[0].length
    val height = map.size

    fun normalizedX(x: Int) = if (x >= 0) x % width else ((abs(x) - 1) / width + 1) * width + x
    fun normalizedY(y: Int) = if (y >= 0) y % height else ((abs(y) - 1) / height + 1) * height + y
    fun value(p: Point) = if (p == startPoint!!) {
        'S'
    } else {
        val ch = map[normalizedY(p.y)][normalizedX(p.x)]
        if (ch == 'S') '.' else ch
    }

    if (print) {
        for (y in -100..100) {
            for (x in -100..100) {
                print(value(Point(x, y)))
            }
            println()
        }
    }

    fun Point.next(): Set<Point> {
        return mutableSetOf<Point>().apply {
            this += plus(1, 0)
            this += plus(-1, 0)
            this += plus(0, 1)
            this += plus(0, -1)
        }
            .filter { value(it) == '.' }
            .toSet()
    }

    fun bfs(): Set<Point> {
        var opened = mutableSetOf<Point>()

        opened += startPoint!!
        var steps = 0

        while (opened.isNotEmpty()) {
            val achievable = mutableSetOf<Point>()
            for (currentPoint in opened) {
                val next = currentPoint.next()
                for (nextPoint in next) {
                    achievable += nextPoint
                }
            }
            opened = achievable

            ++steps

            if (print) {
                println("step $steps")
                for (row in rows) {
                    for (col in cols) {
                        if (Point(col, row) in achievable) {
                            print('O')
                        } else {
                            print(map[row][col])
                        }
                    }
                    println()
                }
                println()
            }

            if (steps == stepsCount) {
                return achievable
            }
        }

        return emptySet()
    }

    return bfs().size + 1L
}
